<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StudentScope Analytics Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --primary: #4F46E5;
  --primary-dark: #4338CA;
  --secondary: #10B981;
  --danger: #EF4444;
  --warning: #F59E0B;
  --gray-50: #F9FAFB;
  --gray-100: #F3F4F6;
  --gray-200: #E5E7EB;
  --gray-600: #4B5563;
  --gray-800: #1F2937;
  --gray-900: #111827;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  background: white;
  border-radius: 24px;
  overflow: hidden;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  min-height: 90vh;
}

/* Header */
.analytics-header {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  padding: 30px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.analytics-header h1 {
  font-size: 32px;
  font-weight: 800;
}

.header-actions {
  display: flex;
  gap: 15px;
}

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-white {
  background: white;
  color: var(--primary);
}

.btn-white:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.btn-outline {
  background: transparent;
  border: 2px solid white;
  color: white;
}

/* Content */
.analytics-content {
  padding: 40px;
}

/* Filter Bar */
.filter-bar {
  background: var(--gray-50);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 30px;
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  align-items: center;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.filter-group label {
  font-size: 12px;
  font-weight: 600;
  color: var(--gray-600);
  text-transform: uppercase;
}

.filter-select {
  padding: 10px 15px;
  border: 2px solid var(--gray-200);
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  background: white;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: white;
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  padding: 24px;
  text-align: center;
}

.stat-value {
  font-size: 48px;
  font-weight: 800;
  margin-bottom: 8px;
}

.stat-value.positive { color: var(--secondary); }
.stat-value.negative { color: var(--danger); }
.stat-value.neutral { color: var(--primary); }

.stat-label {
  color: var(--gray-600);
  font-size: 14px;
  font-weight: 600;
}

.stat-change {
  font-size: 12px;
  margin-top: 8px;
  padding: 4px 8px;
  border-radius: 6px;
  display: inline-block;
}

.stat-change.up {
  background: #D1FAE5;
  color: var(--secondary);
}

.stat-change.down {
  background: #FEE2E2;
  color: var(--danger);
}

/* Charts */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 30px;
  margin-bottom: 30px;
}

.chart-card {
  background: white;
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  padding: 24px;
}

.chart-card.full-width {
  grid-column: 1 / -1;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.chart-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--gray-900);
}

.chart-subtitle {
  font-size: 14px;
  color: var(--gray-600);
  margin-top: 4px;
}

/* Heatmap */
.heatmap-container {
  overflow-x: auto;
}

.heatmap {
  display: grid;
  grid-template-columns: 80px repeat(7, 1fr);
  gap: 4px;
  min-width: 600px;
}

.heatmap-cell {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  font-weight: 600;
  font-size: 13px;
  transition: transform 0.2s;
}

.heatmap-cell:hover:not(.heatmap-label) {
  transform: scale(1.1);
  z-index: 10;
}

.heatmap-label {
  background: transparent;
  color: var(--gray-600);
  font-size: 12px;
}

.heatmap-cell[data-intensity="0"] { background: var(--gray-100); color: var(--gray-600); }
.heatmap-cell[data-intensity="1"] { background: #DBEAFE; color: #1E40AF; }
.heatmap-cell[data-intensity="2"] { background: #BFDBFE; color: #1E3A8A; }
.heatmap-cell[data-intensity="3"] { background: #93C5FD; color: #1E3A8A; }
.heatmap-cell[data-intensity="4"] { background: #60A5FA; color: white; }
.heatmap-cell[data-intensity="5"] { background: #3B82F6; color: white; }
.heatmap-cell[data-intensity="6"] { background: #2563EB; color: white; }
.heatmap-cell[data-intensity="7"] { background: #1D4ED8; color: white; }

/* Insights */
.insights-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-bottom: 30px;
}

.insight-card {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  padding: 24px;
  border-radius: 12px;
}

.insight-card h3 {
  font-size: 16px;
  margin-bottom: 12px;
  opacity: 0.9;
}

.insight-value {
  font-size: 28px;
  font-weight: 800;
  margin-bottom: 8px;
}

.insight-description {
  font-size: 14px;
  opacity: 0.9;
}

/* Table */
.data-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

.data-table th {
  background: var(--gray-100);
  padding: 12px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
  color: var(--gray-600);
  text-transform: uppercase;
}

.data-table td {
  padding: 16px 12px;
  border-bottom: 1px solid var(--gray-200);
}

.data-table tr:hover {
  background: var(--gray-50);
}

/* Loading/Empty States */
.loading {
  text-align: center;
  padding: 60px;
  color: var(--gray-600);
}

.loading-spinner {
  font-size: 48px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.empty-state {
  text-align: center;
  padding: 60px;
  color: var(--gray-600);
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 15px;
  opacity: 0.3;
}

.hidden { display: none; }

/* Login Screen */
.login-container {
  max-width: 450px;
  margin: 100px auto;
  background: white;
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

.login-input {
  width: 100%;
  padding: 14px;
  margin-bottom: 15px;
  border: 2px solid var(--gray-200);
  border-radius: 10px;
  font-size: 16px;
}

.login-button {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
}

@media (max-width: 1024px) {
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .charts-grid { grid-template-columns: 1fr; }
  .insights-grid { grid-template-columns: 1fr; }
}

@media (max-width: 768px) {
  .stats-grid { grid-template-columns: 1fr; }
  .filter-bar { flex-direction: column; align-items: stretch; }
}
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-container">
  <h1 style="text-align:center;color:var(--primary);margin-bottom:30px;">ðŸ“Š StudentScope Analytics</h1>
  <input type="email" id="authEmail" class="login-input" placeholder="Email address">
  <input type="password" id="authPassword" class="login-input" placeholder="Password">
  <button id="loginBtn" class="login-button">SIGN IN</button>
  <div id="authError" style="color:var(--danger);text-align:center;margin-top:15px;display:none;"></div>
</div>

<!-- Analytics Dashboard -->
<div id="dashboardScreen" class="container hidden">
  <div class="analytics-header">
    <div>
      <h1>ðŸ“Š Analytics Dashboard</h1>
      <p id="teacherEmail" style="opacity:0.9;margin-top:5px;"></p>
    </div>
    <div class="header-actions">
      <button class="btn btn-white" onclick="exportToPDF()">ðŸ“„ Export PDF</button>
      <button class="btn btn-outline" onclick="auth.signOut()">Sign Out</button>
    </div>
  </div>

  <div class="analytics-content">
    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="filter-group">
        <label>Time Period</label>
        <select id="timePeriodFilter" class="filter-select" onchange="Analytics.loadData()">
          <option value="7">Last 7 Days</option>
          <option value="30" selected>Last 30 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="365">Last Year</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Student</label>
        <select id="studentFilter" class="filter-select" onchange="Analytics.loadData()">
          <option value="all">All Students</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Behavior Type</label>
        <select id="behaviorTypeFilter" class="filter-select" onchange="Analytics.loadData()">
          <option value="all">All Behaviors</option>
          <option value="positive">Positive Only</option>
          <option value="negative">Negative Only</option>
        </select>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value neutral" id="totalBehaviors">0</div>
        <div class="stat-label">Total Behaviors</div>
        <div class="stat-change down" id="totalChange">â†“ 0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-value positive" id="positiveBehaviors">0</div>
        <div class="stat-label">Positive Behaviors</div>
        <div class="stat-change up" id="positiveChange">â†‘ 0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-value negative" id="negativeBehaviors">0</div>
        <div class="stat-label">Incidents</div>
        <div class="stat-change down" id="negativeChange">â†“ 0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-value neutral" id="avgPerDay">0</div>
        <div class="stat-label">Avg Per Day</div>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
      <!-- Trend Line -->
      <div class="chart-card full-width">
        <div class="chart-header">
          <div>
            <div class="chart-title">Behavior Trends Over Time</div>
            <div class="chart-subtitle">Daily behavior counts showing intervention effectiveness</div>
          </div>
        </div>
        <canvas id="trendChart" height="80"></canvas>
      </div>

      <!-- Behavior Type Breakdown -->
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Behavior Type Distribution</div>
        </div>
        <canvas id="pieChart"></canvas>
      </div>

      <!-- Time of Day -->
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Incidents by Hour</div>
        </div>
        <canvas id="hourChart"></canvas>
      </div>
    </div>

    <!-- Heatmap -->
    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title">Behavior Heatmap</div>
          <div class="chart-subtitle">When do incidents typically occur?</div>
        </div>
      </div>
      <div class="heatmap-container">
        <div class="heatmap" id="heatmap">
          <!-- Generated dynamically -->
        </div>
      </div>
    </div>

    <!-- Insights -->
    <div class="insights-grid">
      <div class="insight-card">
        <h3>Peak Incident Time</h3>
        <div class="insight-value" id="peakTime">--:--</div>
        <div class="insight-description" id="peakDescription">Loading...</div>
      </div>
      <div class="insight-card" style="background: linear-gradient(135deg, var(--secondary), #059669);">
        <h3>Biggest Improvement</h3>
        <div class="insight-value" id="improvementStudent">--</div>
        <div class="insight-description" id="improvementDescription">Loading...</div>
      </div>
    </div>

    <!-- Student Breakdown Table -->
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">Student Breakdown</div>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>Student</th>
            <th>Total Behaviors</th>
            <th>Positive</th>
            <th>Incidents</th>
            <th>Trend</th>
          </tr>
        </thead>
        <tbody id="studentTable">
          <tr><td colspan="5" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDFI44iKYUJNu9-67UkfHQHeKHBRAjKleA",
  authDomain: "studentscopebehaviorcenter.firebaseapp.com",
  projectId: "studentscopebehaviorcenter",
  storageBucket: "studentscopebehaviorcenter.firebasestorage.app",
  messagingSenderId: "311398911099",
  appId: "1:311398911099:web:6703268a2b65cdd969a6de"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentTeacherId = null;
let allBehaviors = [];
let students = [];
let trendChart, pieChart, hourChart;

// Auth
auth.onAuthStateChanged(user => {
  if (user) {
    currentTeacherId = user.uid;
    document.getElementById('teacherEmail').textContent = user.email;
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('dashboardScreen').classList.remove('hidden');
    Analytics.init();
  } else {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('dashboardScreen').classList.add('hidden');
  }
});

document.getElementById('loginBtn').addEventListener('click', async () => {
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value;
  
  try {
    await auth.signInWithEmailAndPassword(email, password);
  } catch (error) {
    document.getElementById('authError').textContent = error.message;
    document.getElementById('authError').style.display = 'block';
  }
});

// Analytics Engine
const Analytics = {
  async init() {
    await this.loadStudents();
    await this.loadData();
  },

  async loadStudents() {
    const snapshot = await db.collection('students')
      .where('teacherId', '==', currentTeacherId)
      .get();
    
    students = [];
    const select = document.getElementById('studentFilter');
    select.innerHTML = '<option value="all">All Students</option>';
    
    snapshot.forEach(doc => {
      const student = { id: doc.id, ...doc.data() };
      students.push(student);
      const option = document.createElement('option');
      option.value = student.id;
      option.textContent = student.name;
      select.appendChild(option);
    });
  },

  async loadData() {
    const days = parseInt(document.getElementById('timePeriodFilter').value);
    const studentId = document.getElementById('studentFilter').value;
    const behaviorType = document.getElementById('behaviorTypeFilter').value;
    
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - days);
    
    let query = db.collection('behaviors')
      .where('teacherId', '==', currentTeacherId)
      .where('timestamp', '>=', cutoffDate.toISOString());
    
    const snapshot = await query.get();
    allBehaviors = [];
    
    snapshot.forEach(doc => {
      const behavior = { id: doc.id, ...doc.data() };
      
      // Apply filters
      if (studentId !== 'all' && behavior.studentId !== studentId) return;
      if (behaviorType !== 'all' && behavior.type !== behaviorType) return;
      
      allBehaviors.push(behavior);
    });
    
    this.updateStats();
    this.updateCharts();
    this.updateHeatmap();
    this.updateInsights();
    this.updateStudentTable();
  },

  updateStats() {
    const total = allBehaviors.length;
    const positive = allBehaviors.filter(b => b.type === 'positive').length;
    const negative = allBehaviors.filter(b => b.type === 'negative').length;
    const days = parseInt(document.getElementById('timePeriodFilter').value);
    const avgPerDay = (total / days).toFixed(1);
    
    document.getElementById('totalBehaviors').textContent = total;
    document.getElementById('positiveBehaviors').textContent = positive;
    document.getElementById('negativeBehaviors').textContent = negative;
    document.getElementById('avgPerDay').textContent = avgPerDay;
    
    // Calculate trends (compare to previous period)
    const halfPoint = Math.floor(allBehaviors.length / 2);
    const recent = allBehaviors.slice(0, halfPoint);
    const previous = allBehaviors.slice(halfPoint);
    
    const recentNegative = recent.filter(b => b.type === 'negative').length;
    const previousNegative = previous.filter(b => b.type === 'negative').length;
    
    if (previousNegative > 0) {
      const change = ((recentNegative - previousNegative) / previousNegative * 100).toFixed(0);
      document.getElementById('negativeChange').textContent = change > 0 ? `â†‘ ${change}%` : `â†“ ${Math.abs(change)}%`;
      document.getElementById('negativeChange').className = change > 0 ? 'stat-change up' : 'stat-change down';
    }
  },

  updateCharts() {
    this.createTrendChart();
    this.createPieChart();
    this.createHourChart();
  },

  createTrendChart() {
    const ctx = document.getElementById('trendChart').getContext('2d');
    
    // Group by date
    const dateMap = new Map();
    allBehaviors.forEach(b => {
      const date = new Date(b.timestamp).toLocaleDateString();
      if (!dateMap.has(date)) {
        dateMap.set(date, { positive: 0, negative: 0 });
      }
      dateMap.get(date)[b.type]++;
    });
    
    const dates = Array.from(dateMap.keys()).sort();
    const positiveData = dates.map(d => dateMap.get(d).positive);
    const negativeData = dates.map(d => dateMap.get(d).negative);
    
    if (trendChart) trendChart.destroy();
    
    trendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [
          {
            label: 'Positive Behaviors',
            data: positiveData,
            borderColor: '#10B981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.3
          },
          {
            label: 'Incidents',
            data: negativeData,
            borderColor: '#EF4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: 'top' }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  },

  createPieChart() {
    const ctx = document.getElementById('pieChart').getContext('2d');
    const positive = allBehaviors.filter(b => b.type === 'positive').length;
    const negative = allBehaviors.filter(b => b.type === 'negative').length;
    
    if (pieChart) pieChart.destroy();
    
    pieChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Positive', 'Incidents'],
        datasets: [{
          data: [positive, negative],
          backgroundColor: ['#10B981', '#EF4444']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  },

  createHourChart() {
    const ctx = document.getElementById('hourChart').getContext('2d');
    
    // Group by hour
    const hourCounts = new Array(24).fill(0);
    allBehaviors.filter(b => b.type === 'negative').forEach(b => {
      const hour = new Date(b.timestamp).getHours();
      hourCounts[hour]++;
    });
    
    if (hourChart) hourChart.destroy();
    
    hourChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
        datasets: [{
          label: 'Incidents by Hour',
          data: hourCounts,
          backgroundColor: '#4F46E5'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  },

  updateHeatmap() {
    const container = document.getElementById('heatmap');
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const hours = ['8-9am', '9-10am', '10-11am', '11-12pm', '12-1pm', '1-2pm', '2-3pm', '3-4pm'];
    
    // Initialize grid
    const grid = Array.from({length: hours.length}, () => Array(7).fill(0));
    
    // Count incidents
    allBehaviors.filter(b => b.type === 'negative').forEach(b => {
      const date = new Date(b.timestamp);
      const day = date.getDay();
      const hour = date.getHours();
      
      if (hour >= 8 && hour < 16) {
        const hourIndex = hour - 8;
        grid[hourIndex][day === 0 ? 6 : day - 1]++;
      }
    });
    
    // Find max for scaling
    const maxCount = Math.max(...grid.flat());
    
    // Render heatmap
    container.innerHTML = '';
    
    // Header row
    container.appendChild(this.createHeatmapCell('', true));
    days.forEach(day => container.appendChild(this.createHeatmapCell(day, true)));
    
    // Data rows
    grid.forEach((row, i) => {
      container.appendChild(this.createHeatmapCell(hours[i], true));
      row.forEach(count => {
        const intensity = maxCount > 0 ? Math.ceil((count / maxCount) * 7) : 0;
        const cell = this.createHeatmapCell(count || '', false);
        cell.dataset.intensity = intensity;
        cell.title = `${count} incident${count !== 1 ? 's' : ''}`;
        container.appendChild(cell);
      });
    });
  },

  createHeatmapCell(content, isLabel) {
    const cell = document.createElement('div');
    cell.className = `heatmap-cell ${isLabel ? 'heatmap-label' : ''}`;
    cell.textContent = content;
    return cell;
  },

  updateInsights() {
    // Peak incident time
    const hourCounts = new Array(24).fill(0);
    allBehaviors.filter(b => b.type === 'negative').forEach(b => {
      const hour = new Date(b.timestamp).getHours();
      hourCounts[hour]++;
    });
    
    const peakHour = hourCounts.indexOf(Math.max(...hourCounts));
    const peakCount = hourCounts[peakHour];
    
    document.getElementById('peakTime').textContent = `${peakHour}:00`;
    document.getElementById('peakDescription').textContent = `${peakCount} incidents typically occur at this time`;
    
    // Biggest improvement
    const studentProgress = new Map();
    allBehaviors.forEach(b => {
      if (!studentProgress.has(b.studentName)) {
        studentProgress.set(b.studentName, { early: 0, recent: 0 });
      }
      const date = new Date(b.timestamp);
      const daysAgo = (new Date() - date) / (1000 * 60 * 60 * 24);
      
      if (b.type === 'negative') {
        if (daysAgo > 15) {
          studentProgress.get(b.studentName).early++;
        } else {
          studentProgress.get(b.studentName).recent++;
        }
      }
    });
    
    let bestStudent = '';
    let bestImprovement = 0;
    
    studentProgress.forEach((progress, name) => {
      if (progress.early > 0) {
        const improvement = ((progress.early - progress.recent) / progress.early * 100);
        if (improvement > bestImprovement) {
          bestImprovement = improvement;
          bestStudent = name;
        }
      }
    });
    
    document.getElementById('improvementStudent').textContent = bestStudent || 'N/A';
    document.getElementById('improvementDescription').textContent = 
      bestImprovement > 0 ? `${bestImprovement.toFixed(0)}% reduction in incidents` : 'Not enough data yet';
  },

  updateStudentTable() {
    const tbody = document.getElementById('studentTable');
    tbody.innerHTML = '';
    
    const studentStats = new Map();
    
    allBehaviors.forEach(b => {
      if (!studentStats.has(b.studentName)) {
        studentStats.set(b.studentName, { total: 0, positive: 0, negative: 0 });
      }
      const stats = studentStats.get(b.studentName);
      stats.total++;
      stats[b.type]++;
    });
    
    studentStats.forEach((stats, name) => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td><strong>${name}</strong></td>
        <td>${stats.total}</td>
        <td style="color:#10B981;font-weight:600;">${stats.positive}</td>
        <td style="color:#EF4444;font-weight:600;">${stats.negative}</td>
        <td>${stats.positive > stats.negative ? 'ðŸ“ˆ Improving' : 'ðŸ“Š Monitoring'}</td>
      `;
    });
    
    if (studentStats.size === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--gray-600);padding:40px;">No data available</td></tr>';
    }
  }
};

// Export to PDF
async function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');
  
  // Title
  pdf.setFontSize(20);
  pdf.text('StudentScope Analytics Report', 20, 20);
  
  pdf.setFontSize(12);
  pdf.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 30);
  pdf.text(`Period: ${document.getElementById('timePeriodFilter').options[document.getElementById('timePeriodFilter').selectedIndex].text}`, 20, 37);
  
  // Stats
  pdf.setFontSize(16);
  pdf.text('Summary Statistics', 20, 50);
  
  pdf.setFontSize(12);
  const total = document.getElementById('totalBehaviors').textContent;
  const positive = document.getElementById('positiveBehaviors').textContent;
  const negative = document.getElementById('negativeBehaviors').textContent;
  
  pdf.text(`Total Behaviors: ${total}`, 20, 60);
  pdf.text(`Positive Behaviors: ${positive}`, 20, 67);
  pdf.text(`Incidents: ${negative}`, 20, 74);
  
  // Insights
  pdf.setFontSize(16);
  pdf.text('Key Insights', 20, 90);
  
  pdf.setFontSize(12);
  const peakTime = document.getElementById('peakTime').textContent;
  const peakDesc = document.getElementById('peakDescription').textContent;
  
  pdf.text(`Peak Incident Time: ${peakTime}`, 20, 100);
  pdf.text(peakDesc, 20, 107);
  
  pdf.save('studentscope-analytics.pdf');
  
  alert('ðŸ“„ PDF Report Generated!');
}
</script>
</body>
</html>
