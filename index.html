<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StudentScope | Behavior Tracking</title>
<style>
/* === CORE STYLES === */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
body { background: #f8fafc; padding: 20px; }
.container { max-width: 1200px; margin: 0 auto; }

/* Header */
header { text-align: center; margin-bottom: 30px; padding: 25px;
background: linear-gradient(135deg, #4a6fa5 0%, #2c3e50 100%); border-radius: 15px; color: white; }
h1 { font-size: 2.8rem; margin-bottom: 10px; }

/* LOGIN SCREEN STYLES */
.login-container { max-width: 450px; margin: 100px auto; }
.login-card { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
.login-card h2 { color: #2c3e50; margin-bottom: 30px; text-align: center; }
.login-input { width: 100%; padding: 14px; margin-bottom: 15px; border: 2px solid #e0e6ed;
border-radius: 10px; font-size: 1rem; }
.login-button { width: 100%; padding: 16px; background: linear-gradient(135deg, #4a6fa5, #2c3e50);
color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600;
cursor: pointer; margin-top: 10px; }
.login-button:hover { opacity: 0.9; }
.toggle-auth { text-align: center; margin-top: 20px; color: #7f8c8d; }
.toggle-auth a { color: #4a6fa5; cursor: pointer; text-decoration: underline; }
.logout-button { padding: 10px 20px; background: #e74c3c; color: white; border: none;
border-radius: 8px; cursor: pointer; margin-left: 15px; }
.user-info { display: inline-block; margin-right: 15px; color: white; opacity: 0.9; }

/* 3-Column Grid */
.three-columns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
@media (max-width: 1024px) { .three-columns { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) { .three-columns { grid-template-columns: 1fr; } }

/* Cards */
.card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
.card h2 { color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid; }
.card-1 h2 { border-color: #27ae60; } .card-2 h2 { border-color: #9b59b6; } .card-3 h2 { border-color: #3498db; }

/* Form Elements */
.form-group { margin-bottom: 20px; }
label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
input, textarea, select { width: 100%; padding: 14px; border: 2px solid #e0e6ed; border-radius: 10px; font-size: 1rem; }
textarea { min-height: 120px; resize: vertical; }

/* Buttons */
.save-button { width: 100%; padding: 16px; background: linear-gradient(135deg, #27ae60, #219653);
color: white; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: 600; cursor: pointer; margin-top: 10px; }
.good-behavior-button { width: 100%; padding: 16px; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none;
border-radius: 10px; font-size: 1.2rem; font-weight: 600; cursor: pointer; margin-top: 10px; }
.ai-button { width: 100%; padding: 16px; background: linear-gradient(135deg, #9b59b6, #8e44ad);
color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 15px; }

/* Export Buttons Container */
.export-buttons { display: flex; gap: 10px; margin-top: 15px; }
.email-button {
  flex: 1;
  padding: 12px 20px;
  background: linear-gradient(135deg, #e67e22, #d35400);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
}
.email-button:hover { transform: translateY(-2px); }

.docs-button {
  flex: 1;
  padding: 12px 20px;
  background: linear-gradient(135deg, #4285f4, #3367d6);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
}
.docs-button:hover { transform: translateY(-2px); }

.google-signin-button {
  width: 100%;
  padding: 12px 20px;
  background: white;
  color: #757575;
  border: 1px solid #dadce0;
  border-radius: 8px;
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
  transition: background-color 0.2s;
}
.google-signin-button:hover { background-color: #f8f9fa; }

/* Log Display */
#logContainer { max-height: 400px; overflow-y: auto; margin-top: 20px; padding-top: 20px; }
.log-entry { background: #f8fafc; padding: 20px; margin-bottom: 15px; border-left: 5px solid #4a6fa5; border-radius: 0 10px 10px 0; }
.student-name { font-weight: bold; color: #2c3e50; font-size: 1.2rem; }
.log-date { color: #7f8c8d; font-size: 0.9rem; margin-top: 5px; }
.delete-btn { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 6px; margin-top: 10px; cursor: pointer; }

/* ABC Editor (Collapsible) */
.abc-expandable { margin-top: 15px; max-height: 0; overflow: hidden; transition: max-height 0.4s; background: #f0f7ff; }
.abc-expandable.expanded { max-height: 500px; padding: 20px; border: 1px solid #d0e0f0; }
.edit-abc-btn { background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer; margin-top: 10px; }
.save-abc-btn { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; margin-top: 10px; width: 100%; }

/* Loading/Hidden */
.hidden { display: none; }
.loading { text-align: center; padding: 40px; color: #7f8c8d; }

/* Status Messages */
.status-message {
  padding: 12px 20px;
  border-radius: 8px;
  margin-top: 10px;
  font-size: 0.9rem;
  text-align: center;
}
.status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.status-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
</style>
</head>
<body>

<!-- ========== LOGIN SCREEN ========== -->
<div id="loginScreen" class="login-container">
<div class="login-card">
<h1 style="text-align:center;color:#4a6fa5;margin-bottom:10px;">ü§ñ StudentScope</h1>
<p style="text-align:center;color:#7f8c8d;margin-bottom:30px;">Secure Teacher Login</p>
<h2 id="authTitle">Sign In</h2>
<input type="email" id="authEmail" class="login-input" placeholder="Email address" required>
<input type="password" id="authPassword" class="login-input" placeholder="Password" required>
<button id="authButton" class="login-button">SIGN IN</button>
<div class="toggle-auth">
<span id="authToggleText">Don't have an account? <a id="authToggle">Sign up</a></span>
</div>
<div id="authError" style="color:#e74c3c;text-align:center;margin-top:15px;display:none;"></div>
</div>
</div>

<!-- ========== MAIN APP (hidden until logged in) ========== -->
<div id="mainApp" class="hidden">
<div class="container">
<header>
<div style="display:flex;justify-content:space-between;align-items:center;">
<div>
<h1>ü§ñ StudentScope <span style="background:#ff6b6b;color:white;padding:4px 12px;border-radius:20px;font-size:0.8rem;">FIREBASE</span></h1>
<p style="font-size:1.2rem;opacity:0.9;">AI-assisted behavior tracking for modern educators</p>
</div>
<div>
<span class="user-info" id="userEmail"></span>
<button id="logoutBtn" class="logout-button">üö™ Logout</button>
</div>
</div>
</header>

<div class="three-columns">
<!-- COLUMN 1: SIMPLE LOG FORM -->
<div class="card card-1">
<h2>üìù 1. Log Behavior</h2>
<div id="behaviorForm">
<div class="form-group"><label>Student Name</label><input type="text" id="studentName" placeholder="Type student's name" required></div>
<div class="form-group"><label>What happened?</label><textarea id="behavior" placeholder="Describe the behavior in detail..." required></textarea></div>
<button type="button" id="saveBtn" class="save-button">üíæ SAVE BEHAVIOR</button>
<button type="button" id="goodBehaviorBtn" class="good-behavior-button">‚≠ê GOOD BEHAVIOR ALERT</button>  
</div>
</div>

<!-- COLUMN 2: AI ASSISTANT -->
<div class="card card-2">
<h2>üß† 2. AI Assistant</h2>
<p><em>Get AI suggestions for strategies and report wording</em></p>
<div class="form-group"><label>Describe the situation</label><textarea id="aiPrompt" placeholder="E.g., 'Student becomes agitated during transitions...'"></textarea></div>
<div class="form-group"><label>Focus area</label>
<select id="aiFocus">
<option value="strategies">Behavior Strategies</option>
<option value="report">Report Wording</option>
<option value="intervention">Intervention Ideas</option>
<option value="parent">Parent Communication</option>
</select>
</div>
<button id="aiButton" class="ai-button">ü§ñ GET AI SUGGESTIONS</button>
<div id="aiOutput" style="margin-top:20px;padding:20px;background:#f8f5ff;border-radius:10px;min-height:200px;">
<div style="text-align:center;padding:40px 20px;color:#95a5a6;">
<div style="font-size:3rem;opacity:0.5;">ü§ñ</div>
<p>AI suggestions will appear here</p>
<p style="font-size:0.9rem;">Describe a situation above and click the button.</p>
</div>
</div>
</div>

<!-- COLUMN 3: LOGS WITH EXPORT OPTIONS -->
<div class="card card-3">
<h2 style="margin-bottom: 10px;">üìã 3. Behavior Log</h2>
<p style="margin-bottom: 15px;"><em>All logged behaviors appear here automatically</em></p>
<div class="export-buttons">
<button id="emailReportBtn" class="email-button">üìß Email Report</button>
<button id="googleDocsBtn" class="docs-button">üìÑ Create Google Doc</button>
</div>
<div id="googleAuthStatus" class="hidden"></div>
<div id="logContainer">
<div style="text-align:center;padding:40px 20px;color:#95a5a6;">
<div style="font-size:3rem;opacity:0.5;">üìã</div>
<p>No behaviors logged yet.</p>
<p style="font-size:0.9rem;">Save your first behavior in the left column.</p>
</div>
</div>
</div>
</div>

<footer style="text-align:center;margin-top:40px;color:#7f8c8d;padding:20px;">
<p>StudentScope LLC ‚Ä¢ <span style="color:#9b59b6;font-weight:600;">Powered by Firebase</span> ‚Ä¢ Secure Cloud Storage ‚Ä¢ Made for educators</p>
</footer>
</div>
</div>

<!-- ========== FIREBASE SDK ========== -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- ========== GOOGLE API SDK ========== -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<script>
// ========== FIREBASE CONFIG ==========
const firebaseConfig = {
  apiKey: "AIzaSyDFI44iKYUJNu9-67UkfHQHeKHBRAjKleA",
  authDomain: "studentscopebehaviorcenter.firebaseapp.com",
  projectId: "studentscopebehaviorcenter",
  storageBucket: "studentscopebehaviorcenter.firebasestorage.app",
  messagingSenderId: "311398911099",
  appId: "1:311398911099:web:6703268a2b65cdd969a6de"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ========== GOOGLE DOCS API CONFIG ==========
// IMPORTANT: Replace this with your actual Google Cloud Project credentials
const GOOGLE_CLIENT_ID = '748816477844-tl5ed24gov0dv6sbmtq8ds10ee1aomir.apps.googleusercontent.com' ;

const GOOGLE_API_KEY = 'AIzaSyAJGiPrtsgat2NgPMbSEzMwKbrh38KkUjI' ;
const SCOPES = 'https://www.googleapis.com/auth/documents https://www.googleapis.com/auth/drive.file';

// ========== GOOGLE DOCS MANAGER ==========
const GoogleDocsManager = {
  isSignedIn: false,
  accessToken: null,

  init() {
    // Load the Google API client
    gapi.load('client', () => {
      gapi.client.init({
        apiKey: GOOGLE_API_KEY,
        discoveryDocs: ['https://docs.googleapis.com/$discovery/rest?version=v1'],
      }).then(() => {
        console.log('Google API client initialized');
      }).catch(err => {
        console.error('Error initializing Google API:', err);
      });
    });
  },

  async signIn() {
    return new Promise((resolve, reject) => {
      const client = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SCOPES,
        callback: (response) => {
          if (response.access_token) {
            this.accessToken = response.access_token;
            this.isSignedIn = true;
            this.updateAuthStatus('Connected to Google Docs ‚úì', 'success');
            resolve(response.access_token);
          } else {
            reject('No access token received');
          }
        },
      });
      client.requestAccessToken();
    });
  },

  async createDocument(logs) {
    if (!this.isSignedIn) {
      try {
        await this.signIn();
      } catch (error) {
        this.updateAuthStatus('Please authorize Google Docs access', 'error');
        return;
      }
    }

    try {
      // Create a new Google Doc
      const createResponse = await fetch('https://docs.googleapis.com/v1/documents', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.accessToken}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title: `StudentScope Report - ${new Date().toLocaleDateString()}`
        })
      });

      const doc = await createResponse.json();
     
      if (!doc.documentId) {
        throw new Error('Failed to create document');
      }

      // Build the content for the document
      const requests = this.buildDocumentContent(logs);

      // Update the document with content
      await fetch(`https://docs.googleapis.com/v1/documents/${doc.documentId}:batchUpdate`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.accessToken}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ requests })
      });

      // Open the document in a new tab
      window.open(`https://docs.google.com/document/d/${doc.documentId}/edit`, '_blank');
     
      this.updateAuthStatus(`Document created! Opening in new tab...`, 'success');
     
    } catch (error) {
      console.error('Error creating Google Doc:', error);
      this.updateAuthStatus('Error creating document. Please try again.', 'error');
    }
  },

  buildDocumentContent(logs) {
    const requests = [];
    let currentIndex = 1;

    // Title
    requests.push({
      insertText: {
        location: { index: 1 },
        text: `STUDENTSCOPE BEHAVIOR REPORT\n${new Date().toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })}\n\n`
      }
    });

    // Title formatting
    requests.push({
      updateParagraphStyle: {
        range: { startIndex: 1, endIndex: 30 },
        paragraphStyle: {
          namedStyleType: 'HEADING_1',
          alignment: 'CENTER'
        },
        fields: 'namedStyleType,alignment'
      }
    });

    // Add each log entry
    logs.forEach((log, index) => {
      const logDate = new Date(log.date);
      const dateTime = logDate.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      let logText = `${index + 1}. ${log.studentName} - ${dateTime}\n`;
      logText += `Behavior: ${log.behavior}\n`;
     
      if (log.antecedent) {
        logText += `Antecedent: ${log.antecedent}\n`;
      }
      if (log.consequence) {
        logText += `Consequence: ${log.consequence}\n`;
      }
     
      logText += '\n';

      requests.push({
        insertText: {
          location: { index: currentIndex },
          text: logText
        }
      });
    });

    return requests;
  },

  updateAuthStatus(message, type) {
    const statusDiv = document.getElementById('googleAuthStatus');
    statusDiv.className = `status-message status-${type}`;
    statusDiv.textContent = message;
    statusDiv.classList.remove('hidden');
   
    setTimeout(() => {
      statusDiv.classList.add('hidden');
    }, 5000);
  }
};

// ========== AUTHENTICATION LOGIC ==========
const AuthManager = {
  isSignUp: false,
  currentUser: null,

  init() {
    // Listen for auth state changes
    auth.onAuthStateChanged(user => {
      if (user) {
        this.currentUser = user;
        this.showMainApp();
        App.init();
      } else {
        this.currentUser = null;
        this.showLoginScreen();
      }
    });

    // Setup login/signup toggle
    document.getElementById('authToggle').addEventListener('click', () => this.toggleAuthMode());
    document.getElementById('authButton').addEventListener('click', () => this.handleAuth());
    document.getElementById('logoutBtn').addEventListener('click', () => this.logout());

    // Enter key to submit
    document.getElementById('authPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.handleAuth();
    });
  },

  toggleAuthMode() {
    this.isSignUp = !this.isSignUp;
    document.getElementById('authTitle').textContent = this.isSignUp ? 'Sign Up' : 'Sign In';
    document.getElementById('authButton').textContent = this.isSignUp ? 'CREATE ACCOUNT' : 'SIGN IN';
    document.getElementById('authToggleText').innerHTML = this.isSignUp
      ? 'Already have an account? <a id="authToggle">Sign in</a>'
      : 'Don\'t have an account? <a id="authToggle">Sign up</a>';
   
    // Re-attach the toggle listener
    document.getElementById('authToggle').addEventListener('click', () => this.toggleAuthMode());
  },

  async handleAuth() {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    const errorDiv = document.getElementById('authError');

    if (!email || !password) {
      this.showError('Please enter both email and password');
      return;
    }

    try {
      if (this.isSignUp) {
        await auth.createUserWithEmailAndPassword(email, password);
        console.log('Account created successfully');
      } else {
        await auth.signInWithEmailAndPassword(email, password);
        console.log('Signed in successfully');
      }
      errorDiv.style.display = 'none';
    } catch (error) {
      this.showError(this.getErrorMessage(error.code));
    }
  },

  showError(message) {
    const errorDiv = document.getElementById('authError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
  },

  getErrorMessage(code) {
    switch(code) {
      case 'auth/invalid-email': return 'Invalid email format';
      case 'auth/user-not-found': return 'No account found with this email';
      case 'auth/wrong-password': return 'Incorrect password';
      case 'auth/email-already-in-use': return 'Email already registered';
      case 'auth/weak-password': return 'Password must be at least 6 characters';
      default: return 'Authentication error. Please try again.';
    }
  },

  logout() {
    auth.signOut();
  },

  showLoginScreen() {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
  },

  showMainApp() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userEmail').textContent = this.currentUser.email;
  }
};

// ========== MAIN APP LOGIC (with Firestore) ==========
const App = {
  logs: [],
  unsubscribe: null, // For real-time listener

  init() {
    this.setupEventListeners();
    this.listenToLogs();
    GoogleDocsManager.init();
    console.log("StudentScope Firebase ready");
  },

  setupEventListeners() {
    document.getElementById('saveBtn').addEventListener('click', () => this.saveBehavior());
    document.getElementById('goodBehaviorBtn').addEventListener('click', () => this.saveGoodBehavior());
    document.getElementById('emailReportBtn').addEventListener('click', () => this.emailReport());
    document.getElementById('googleDocsBtn').addEventListener('click', () => this.createGoogleDoc());
    document.getElementById('aiButton').addEventListener('click', () => this.generateAISuggestions());
  },

  // ========== FIRESTORE: LISTEN TO LOGS IN REAL-TIME ==========
  listenToLogs() {
    const userId = auth.currentUser.uid;
   
    // Real-time listener - updates automatically when data changes
    this.unsubscribe = db.collection('users')
      .doc(userId)
      .collection('logs')
      .orderBy('date', 'desc')
      .onSnapshot(snapshot => {
        this.logs = [];
        document.getElementById('logContainer').innerHTML = '';

        if (snapshot.empty) {
          document.getElementById('logContainer').innerHTML = `
            <div style="text-align:center;padding:40px 20px;color:#95a5a6;">
              <div style="font-size:3rem;opacity:0.5;">üìã</div>
              <p>No behaviors logged yet.</p>
              <p style="font-size:0.9rem;">Save your first behavior in the left column.</p>
            </div>
          `;
          return;
        }

        snapshot.forEach(doc => {
          const log = { id: doc.id, ...doc.data() };
          this.logs.push(log);
          this.displayLog(log);
        });
      });
  },

  // ========== FIRESTORE: SAVE BEHAVIOR ==========
  async saveBehavior() {
    const studentName = document.getElementById('studentName').value.trim();
    const behavior = document.getElementById('behavior').value.trim();

    if (!studentName || !behavior) {
      alert("Please enter both student name and behavior description");
      return;
    }

    const log = {
      studentName: studentName,
      date: new Date().toISOString(),
      behavior: behavior,
      antecedent: "",
      consequence: "",
      comments: []
    };

    try {
      const userId = auth.currentUser.uid;
      await db.collection('users').doc(userId).collection('logs').add(log);
     
      // Clear form
      document.getElementById('studentName').value = '';
      document.getElementById('behavior').value = '';
      document.getElementById('studentName').focus();
     
      console.log('Behavior saved to Firestore');
    } catch (error) {
      console.error('Error saving behavior:', error);
      alert('Failed to save behavior. Please try again.');
    }
  },

  async saveGoodBehavior() {
    const studentName = document.getElementById('studentName').value.trim();
    const behavior = document.getElementById('behavior').value.trim();

    if (!studentName || !behavior) {
      alert("Please enter both student name and behavior description");
      return;
    }

    const log = {
      studentName: studentName,
      date: new Date().toISOString(),
      behavior: `‚≠ê GOOD BEHAVIOR ALERT ‚≠ê\n${behavior}`,
      antecedent: "",
      consequence: "",
      comments: []
    };

    try {
      const userId = auth.currentUser.uid;
      await db.collection('users').doc(userId).collection('logs').add(log);
     
      document.getElementById('studentName').value = '';
      document.getElementById('behavior').value = '';
      document.getElementById('studentName').focus();
    } catch (error) {
      console.error('Error saving good behavior:', error);
      alert('Failed to save behavior. Please try again.');
    }
  },

  // ========== DISPLAY LOG ==========
  displayLog(log) {
    const container = document.getElementById('logContainer');
    const emptyState = container.querySelector('.empty-state');
    if (emptyState) container.removeChild(emptyState);

    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.dataset.id = log.id;

    const date = new Date(log.date).toLocaleDateString('en-US', {
      month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
    });

    const hasABC = log.antecedent || log.consequence;
    const hasComments = log.comments?.length > 0;

    entry.innerHTML = `
      <div class="student-name">${log.studentName}</div>
      <div class="log-date">${date}</div>
      <div style="margin-top:15px;line-height:1.5;"><strong>Behavior:</strong> ${log.behavior}</div>
      ${log.antecedent ? `<div style="margin-top:8px;"><strong>Antecedent:</strong> ${log.antecedent}</div>` : ''}
      ${log.consequence ? `<div style="margin-top:8px;"><strong>Consequence:</strong> ${log.consequence}</div>` : ''}
      ${hasComments ? `<div style="margin-top:15px;"><strong>Comments:</strong> ${log.comments.length}</div>` : ''}

      <button class="edit-abc-btn" onclick="App.toggleABCEditor('${log.id}')">
        ${hasABC || hasComments ? '‚úèÔ∏è Edit' : '‚ûï Add ABC/Comment'}
      </button>

      <div class="abc-expandable" id="abcEditor-${log.id}">
        <div style="margin-bottom:15px;">
          <label style="color:#2c3e50;font-size:0.9rem;font-weight:600;">Antecedent (What happened BEFORE?)</label>
          <textarea id="antecedent-${log.id}" style="width:100%;min-height:60px;padding:10px;">${log.antecedent || ''}</textarea>
        </div>
        <div style="margin-bottom:15px;">
          <label style="color:#2c3e50;font-size:0.9rem;font-weight:600;">Consequence (What happened AFTER?)</label>
          <textarea id="consequence-${log.id}" style="width:100%;min-height:60px;padding:10px;">${log.consequence || ''}</textarea>
        </div>
        <div style="border-top:1px dashed #c8d6e5;padding-top:15px;">
          <label style="color:#2c3e50;font-size:0.9rem;font-weight:600;">Add a Comment</label>
          <textarea id="newComment-${log.id}" style="width:100%;min-height:60px;padding:10px;" placeholder="Optional notes..."></textarea>
          <button onclick="App.addComment('${log.id}')" class="save-abc-btn">üí¨ Add Comment</button>
        </div>
        <button onclick="App.saveABCData('${log.id}')" class="save-abc-btn">üíæ Save ABC Data</button>
      </div>

      <button onclick="App.deleteLog('${log.id}')" class="delete-btn">üóëÔ∏è Delete</button>
    `;

    container.prepend(entry);
  },

  // ========== ABC EDITOR FUNCTIONS ==========
  toggleABCEditor(logId) {
    const editor = document.getElementById(`abcEditor-${logId}`);
    const button = event.target;

    if (editor.classList.contains('expanded')) {
      editor.classList.remove('expanded');
      button.textContent = button.textContent.includes('Edit') ? '‚úèÔ∏è Edit' : '‚ûï Add ABC/Comment';
    } else {
      document.querySelectorAll('.abc-expandable.expanded').forEach(el => el.classList.remove('expanded'));
      editor.classList.add('expanded');
      button.textContent = '‚ñ≤ Close';
    }
  },

  // ========== FIRESTORE: UPDATE ABC DATA ==========
  async saveABCData(logId) {
    const antecedent = document.getElementById(`antecedent-${logId}`).value.trim();
    const consequence = document.getElementById(`consequence-${logId}`).value.trim();

    try {
      const userId = auth.currentUser.uid;
      await db.collection('users')
        .doc(userId)
        .collection('logs')
        .doc(logId)
        .update({
          antecedent: antecedent,
          consequence: consequence
        });

      document.getElementById(`abcEditor-${logId}`).classList.remove('expanded');
      console.log('ABC data updated');
    } catch (error) {
      console.error('Error updating ABC data:', error);
      alert('Failed to save ABC data');
    }
  },

  // ========== FIRESTORE: ADD COMMENT ==========
  async addComment(logId) {
    const commentText = document.getElementById(`newComment-${logId}`).value.trim();
    if (!commentText) return alert("Please enter a comment");

    const log = this.logs.find(l => l.id === logId);
    if (!log) return;

    const newComment = {
      text: commentText,
      timestamp: new Date().toISOString(),
      author: "Staff"
    };

    const updatedComments = [...(log.comments || []), newComment];

    try {
      const userId = auth.currentUser.uid;
      await db.collection('users')
        .doc(userId)
        .collection('logs')
        .doc(logId)
        .update({ comments: updatedComments });

      document.getElementById(`newComment-${logId}`).value = '';
      console.log('Comment added');
    } catch (error) {
      console.error('Error adding comment:', error);
      alert('Failed to add comment');
    }
  },

  // ========== FIRESTORE: DELETE LOG ==========
  async deleteLog(id) {
    if (!confirm('Delete this behavior log?')) return;

    try {
      const userId = auth.currentUser.uid;
      await db.collection('users')
        .doc(userId)
        .collection('logs')
        .doc(id)
        .delete();

      console.log('Log deleted');
    } catch (error) {
      console.error('Error deleting log:', error);
      alert('Failed to delete log');
    }
  },

  // ========== EMAIL REPORT ==========
  emailReport() {
    if (this.logs.length === 0) {
      alert('No behaviors to email. Log some behaviors first!');
      return;
    }

    // Build email subject and body
    const subject = `StudentScope Behavior Report - ${new Date().toLocaleDateString()}`;
   
    let body = `STUDENTSCOPE BEHAVIOR REPORT\n`;
    body += `Generated: ${new Date().toLocaleString()}\n`;
    body += `Total Entries: ${this.logs.length}\n`;
    body += `\n${'='.repeat(60)}\n\n`;

    this.logs.forEach((log, index) => {
      const logDate = new Date(log.date);
      const dateTime = logDate.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
     
      body += `${index + 1}. ${log.studentName} - ${dateTime}\n`;
      body += `   Behavior: ${log.behavior}\n`;
     
      if (log.antecedent) {
        body += `   Antecedent: ${log.antecedent}\n`;
      }
      if (log.consequence) {
        body += `   Consequence: ${log.consequence}\n`;
      }
     
      if (log.comments && log.comments.length > 0) {
        body += `   Comments: ${log.comments.length} note(s)\n`;
      }
     
      body += `\n`;
    });

    body += `${'='.repeat(60)}\n`;
    body += `\nGenerated by StudentScope - Behavior Tracking System`;

    // Create mailto link
    const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
   
    // Open email client
    window.location.href = mailtoLink;
  },

  // ========== CREATE GOOGLE DOC ==========
  async createGoogleDoc() {
    if (this.logs.length === 0) {
      alert('No behaviors to export. Log some behaviors first!');
      return;
    }

    await GoogleDocsManager.createDocument(this.logs);
  },

  // ========== AI ASSISTANT ==========
  generateAISuggestions() {
    const prompt = document.getElementById('aiPrompt').value.trim();
    const focus = document.getElementById('aiFocus').value;
    const output = document.getElementById('aiOutput');

    if (!prompt) return alert("Please describe a situation");

    output.innerHTML = `<div style="text-align:center;padding:30px;color:#7f8c8d;">ü§î AI is thinking...</div>`;

    setTimeout(() => {
      const suggestions = this.getAISuggestions(prompt, focus);
      output.innerHTML = `
        <h3 style="color:#2c3e50;margin-bottom:20px;">ü§ñ AI Suggestions</h3>
        ${suggestions.map((s, i) => `
          <div style="background:white;padding:15px;margin-bottom:10px;border-radius:8px;border-left:4px solid #9b59b6;">
            <h4 style="color:#2c3e50;margin-bottom:8px;">Suggestion ${i+1}</h4>
            <p>${s}</p>
          </div>
        `).join('')}
      `;
    }, 1000);
  },

  getAISuggestions(prompt, focus) {
    const strategies = [
      "Implement visual schedule with transition warnings.",
      "Use 'break card' system for sensory breaks.",
      "Try token economy with immediate reinforcement.",
      "Provide alternative seating options."
    ];
    return strategies.slice(0, 3);
  }
};

// ========== START THE APP ==========
document.addEventListener('DOMContentLoaded', () => {
  AuthManager.init();
});
</script>
</body>
