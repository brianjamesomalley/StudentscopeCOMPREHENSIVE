<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StudentScope | Behavior Tracking</title>
  <style>
    /* === CORE STYLES === */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
    body { background: #f8fafc; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }

    /* Header */
    header { text-align: center; margin-bottom: 30px; padding: 25px;
    background: linear-gradient(135deg, #4a6fa5 0%, #2c3e50 100%); border-radius: 15px; color: white; }
    h1 { font-size: 2.8rem; margin-bottom: 10px; }

    /* MOBILE HEADER FIX */
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    .header-left { flex: 1; }
    .header-right { display: flex; align-items: center; }
    .user-info { display: inline-block; margin-right: 15px; color: white; opacity: 0.9; }
    .logout-button { padding: 10px 20px; background: #e74c3c; color: white; border: none;
    border-radius: 8px; cursor: pointer; }

    @media (max-width: 768px) {
      h1 { font-size: 2rem; }
      .header-content { flex-direction: column; text-align: center; }
      .header-left { margin-bottom: 15px; }
      .header-right { flex-direction: column; width: 100%; }
      .user-info { margin: 10px 0 0 0; display: block; font-size: 0.9rem; }
      .logout-button { margin: 10px 0 0 0; width: 100%; max-width: 200px; }
    }

    /* LOGIN SCREEN STYLES */
    .login-container { max-width: 450px; margin: 100px auto; }
    .login-card { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    .login-card h2 { color: #2c3e50; margin-bottom: 30px; text-align: center; }
    .login-input { width: 100%; padding: 14px; margin-bottom: 15px; border: 2px solid #e0e6ed;
    border-radius: 10px; font-size: 1rem; }
    .login-button { width: 100%; padding: 16px; background: linear-gradient(135deg, #4a6fa5, #2c3e50);
    color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600;
    cursor: pointer; margin-top: 10px; }
    .login-button:hover { opacity: 0.9; }
    .toggle-auth { text-align: center; margin-top: 20px; color: #7f8c8d; }
    .toggle-auth a { color: #4a6fa5; cursor: pointer; text-decoration: underline; }

    /* 3-Column Grid */
    .three-columns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
    @media (max-width: 1024px) { .three-columns { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) { .three-columns { grid-template-columns: 1fr; } }

    /* Cards */
    .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
    .card h2 { color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid; }
    .card-1 h2 { border-color: #27ae60; } .card-2 h2 { border-color: #9b59b6; } .card-3 h2 { border-color: #3498db; }

    /* Form Elements */
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
    input, textarea, select { width: 100%; padding: 14px; border: 2px solid #e0e6ed; border-radius: 10px; font-size: 1rem; }
    textarea { min-height: 120px; resize: vertical; }

    /* Buttons */
    .save-button { width: 100%; padding: 16px; background: linear-gradient(135deg, #27ae60, #219653);
    color: white; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: 600; cursor: pointer; margin-top: 10px; }
    .good-behavior-button { width: 100%; padding: 16px; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none;
    border-radius: 10px; font-size: 1.2rem; font-weight: 600; cursor: pointer; margin-top: 10px; }
    .ai-button { width: 100%; padding: 16px; background: linear-gradient(135deg, #9b59b6, #8e44ad);
    color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 15px; }

    /* Weekly Report Cards */
    .weekly-report-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .weekly-report-card h3 {
      font-size: 1.3rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .weekly-date-range {
      font-size: 0.95rem;
      opacity: 0.9;
      margin-bottom: 8px;
    }
    .weekly-count {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 15px;
    }
    .weekly-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .weekly-email-btn, .weekly-print-btn {
      flex: 1;
      padding: 12px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .weekly-email-btn:hover, .weekly-print-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    @media (max-width: 768px) {
      .weekly-buttons { flex-direction: column; }
    }

    /* Log Display */
    #logContainer { max-height: 400px; overflow-y: auto; margin-top: 20px; padding-top: 20px; }
    .log-entry { background: #f8fafc; padding: 20px; margin-bottom: 15px; border-left: 5px solid #4a6fa5; border-radius: 0 10px 10px 0; }
    .student-name { font-weight: bold; color: #2c3e50; font-size: 1.2rem; }
    .log-date { color: #7f8c8d; font-size: 0.9rem; margin-top: 5px; }
    .delete-btn { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 6px; margin-top: 10px; cursor: pointer; }

    /* ABC Editor (Collapsible) */
    .abc-expandable { margin-top: 15px; max-height: 0; overflow: hidden; transition: max-height 0.4s; background: #f0f7ff; }
    .abc-expandable.expanded { max-height: 500px; padding: 20px; border: 1px solid #d0e0f0; }
    .edit-abc-btn { background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer; margin-top: 10px; }
    .save-abc-btn { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; margin-top: 10px; width: 100%; }

    /* Loading/Hidden */
    .hidden { display: none; }
    .loading { text-align: center; padding: 40px; color: #7f8c8d; }

    /* Status Messages */
    .status-message {
      padding: 12px 20px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 0.9rem;
      text-align: center;
    }
    .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
  </style>
</head>
<body>

<!-- ========== LOGIN SCREEN ========== -->
<div id="loginScreen" class="login-container">
  <div class="login-card">
    <h1 style="text-align:center;color:#4a6fa5;margin-bottom:10px;">ü§ñ StudentScope</h1>
    <p style="text-align:center;color:#7f8c8d;margin-bottom:30px;">Secure Teacher Login</p>
    <h2 id="authTitle">Sign In</h2>
    <input type="email" id="authEmail" class="login-input" placeholder="Email address" required>
    <input type="password" id="authPassword" class="login-input" placeholder="Password" required>
    <button id="authButton" class="login-button">SIGN IN</button>
    <div class="toggle-auth">
      <span id="authToggleText">Don't have an account? <a id="authToggle">Sign up</a></span>
    </div>
    <div id="authError" style="color:#e74c3c;text-align:center;margin-top:15px;display:none;"></div>
  </div>
</div>

<!-- ========== MAIN APP (hidden until logged in) ========== -->
<div id="mainApp" class="hidden">
  <div class="container">
    <header>
      <div class="header-content">
        <div class="header-left">
          <h1>ü§ñ StudentScope <span style="background:#ff6b6b;color:white;padding:4px 12px;border-radius:20px;font-size:0.8rem;">FIREBASE + AI</span></h1>
          <p style="font-size:1.2rem;opacity:0.9;">AI-powered behavior tracking for modern educators</p>
        </div>
        <div class="header-right">
          <span class="user-info" id="userEmail"></span>
          <button id="logoutBtn" class="logout-button">üö™ Logout</button>
        </div>
      </div>
    </header>

    <div class="three-columns">
      <!-- COLUMN 1: SIMPLE LOG FORM -->
      <div class="card card-1">
        <h2>üìù 1. Log Behavior</h2>
        <div id="behaviorForm">
          <div class="form-group"><label>Student Name</label><input type="text" id="studentName" placeholder="Type student's name" required></div>
          <div class="form-group"><label>What happened?</label><textarea id="behavior" placeholder="Describe the behavior in detail..." required></textarea></div>
          <button type="button" id="saveBtn" class="save-button">üíæ SAVE BEHAVIOR</button>
          <button type="button" id="goodBehaviorBtn" class="good-behavior-button">‚≠ê GOOD BEHAVIOR ALERT</button>  
        </div>
      </div>

      <!-- COLUMN 2: AI ASSISTANT -->
      <div class="card card-2">
        <h2>ü§ñ 2. Claude AI Assistant</h2>
        <p style="margin-bottom:15px;"><em>Professional documentation powered by Claude AI</em></p>
        <div class="form-group">
          <label>Describe the behavior or situation</label>
          <textarea id="aiPrompt" placeholder="E.g., 'Student became upset during math transition and refused to return to seat'"></textarea>
        </div>
        <div class="form-group">
          <label>What do you need?</label>
          <select id="aiFocus">
            <option value="report">Professional Documentation Language</option>
            <option value="parent">Parent Email Draft</option>
            <option value="strategies">Behavior Strategy Suggestions</option>
            <option value="intervention">Intervention Plan Ideas</option>
          </select>
        </div>
        <button id="aiButton" class="ai-button">‚ú® GENERATE WITH CLAUDE AI</button>
        <div id="aiOutput" style="margin-top:20px;padding:20px;background:#f8f5ff;border-radius:10px;min-height:200px;">
          <div style="text-align:center;padding:40px 20px;color:#95a5a6;">
            <div style="font-size:3rem;opacity:0.5;">ü§ñ</div>
            <p style="font-weight:600;margin-bottom:8px;">Real AI-Powered Assistance</p>
            <p style="font-size:0.9rem;">Describe a situation above and select what you need.</p>
            <p style="font-size:0.85rem;margin-top:10px;color:#bbb;">Powered by Claude 3.5 Sonnet</p>
          </div>
        </div>
      </div>

      <!-- COLUMN 3: WEEKLY REPORTS & LOGS -->
      <div class="card card-3">
        <h2 style="margin-bottom: 15px;">üìã 3. Weekly Reports & Log</h2>

        <!-- THIS WEEK'S REPORT -->
        <div class="weekly-report-card" id="thisWeekCard">
          <h3>üìä This Week's Report</h3>
          <div class="weekly-date-range" id="thisWeekRange">Loading...</div>
          <div class="weekly-count" id="thisWeekCount">0 behaviors logged</div>
          <div class="weekly-buttons">
            <button class="weekly-email-btn" onclick="App.emailWeeklyReport('current')">üìß Email</button>
            <button class="weekly-print-btn" onclick="App.printWeeklyReport('current')">üñ®Ô∏è Print</button>
          </div>
        </div>

        <!-- LAST WEEK'S REPORT -->
        <div class="weekly-report-card" id="lastWeekCard" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
          <h3>üìÖ Last Week's Report</h3>
          <div class="weekly-date-range" id="lastWeekRange">Loading...</div>
          <div class="weekly-count" id="lastWeekCount">0 behaviors logged</div>
          <div class="weekly-buttons">
            <button class="weekly-email-btn" onclick="App.emailWeeklyReport('last')">üìß Email</button>
            <button class="weekly-print-btn" onclick="App.printWeeklyReport('last')">üñ®Ô∏è Print</button>
          </div>
        </div>

        <p style="margin: 20px 0 15px 0;"><em>All logged behaviors appear below</em></p>

        <div id="logContainer">
          <div style="text-align:center;padding:40px 20px;color:#95a5a6;">
            <div style="font-size:3rem;opacity:0.5;">üìã</div>
            <p>No behaviors logged yet.</p>
            <p style="font-size:0.9rem;">Save your first behavior in the left column.</p>
          </div>
        </div>
      </div>
    </div>

    <footer style="text-align:center;margin-top:40px;color:#7f8c8d;padding:20px;">
      <p>StudentScope LLC ‚Ä¢ <span style="color:#9b59b6;font-weight:600;">Powered by Firebase + Claude AI</span> ‚Ä¢ Secure Cloud Storage ‚Ä¢ Made for educators</p>
    </footer>
  </div>
</div>

<!-- ========== FIREBASE SDK ========== -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- ========== VERCEL CONFIGURATION ========== -->
<script>
// Vercel environment detection - this helps with build process
window.VERCEL_ENV = process.env.VERCEL_ENV || 'development';
console.log(`StudentScope running on Vercel: ${window.VERCEL_ENV}`);
</script>

<script>
// ========== FIREBASE CONFIG ==========
const firebaseConfig = {
  apiKey: "AIzaSyDFI44iKYUJNu9-67UkfHQHeKHBRAjKleA",
  authDomain: "studentscopebehaviorcenter.firebaseapp.com",
  projectId: "studentscopebehaviorcenter",
  storageBucket: "studentscopebehaviorcenter.firebasestorage.app",
  messagingSenderId: "311398911099",
  appId: "1:311398911099:web:6703268a2b65cdd969a6de"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ========== CLAUDE API CONFIG ==========
const CLAUDE_API_KEY = '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';
const CLAUDE_API_URL = 'https://api.anthropic.com/v1/messages';
// ========== CLAUDE AI INTEGRATION ==========
const ClaudeAI = {
 async generateAISuggestions() {
  const prompt = document.getElementById('aiPrompt').value.trim();
  const focus = document.getElementById('aiFocus').value;
  const output = document.getElementById('aiOutput');

  if (!prompt) {
    alert("Please describe a situation");
    return;
  }

  // Show loading
  output.innerHTML = '<div style="text-align:center;padding:30px;">ü§î Thinking...</div>';

  try {
    // Get the right system prompt
    const systemPrompt = this.getSystemPrompt(focus);
    
    // Call Claude DIRECTLY (with the dangerous header)
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': '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',
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-3-5-sonnet-20241022',
        max_tokens: 1024,
        system: systemPrompt,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    const suggestion = data.content[0].text;
    
    // Display it simply
    output.innerHTML = `<div style="background:white;padding:20px;border-radius:10px;white-space:pre-wrap;">${suggestion}</div>`;
    
  } catch (error) {
    output.innerHTML = `<div style="color:red;padding:20px;">Error: ${error.message}</div>`;
    console.error(error);
  }
}

  getSystemPrompt(focus) {
    const prompts = {
      report: `You are an expert educational professional helping teachers and paraprofessionals write professional behavior documentation. 

Your task: Take informal notes about student behavior and rewrite them in professional, objective, appropriate language suitable for IEP meetings, progress reports, and official documentation.

Guidelines:
- Use professional educational terminology
- Remain objective and factual
- Avoid judgmental language
- Focus on observable behaviors
- Be concise but complete (2-3 sentences maximum)
- Maintain dignity and respect for the student
- Use person-first language

Examples:
Input: "kid freaked out wouldn't sit down"
Output: "Student demonstrated difficulty remaining in assigned seat and exhibited signs of emotional dysregulation during the transition period."

Input: "Tommy hit another kid for no reason"
Output: "Student engaged in physical contact with a peer. The antecedent to this behavior is unclear and requires further observation."

Provide ONLY the rewritten professional version. No explanations, no preamble, just the improved text.`,

      parent: `You are an expert at helping teachers write sensitive, professional communications to parents about challenging student behaviors.

Your task: Draft a tactful, supportive email to parents about a behavior incident.

Guidelines:
- Start with something positive about the student
- Describe the behavior objectively without blame
- Express partnership and support
- Suggest a collaborative approach
- End on a hopeful, constructive note
- Keep it brief (3-4 sentences)
- Avoid educational jargon
- Be warm but professional

Format your response as:
Subject: [Suggest a non-alarming subject line]

Dear [Parent Name],

[Your drafted email - 3-4 sentences]

Best regards,
[Teacher Name]`,

      strategies: `You are a behavior intervention specialist helping educators develop practical, evidence-based strategies for challenging behaviors.

Your task: Suggest 3 specific, actionable behavior strategies based on the described situation.

Guidelines:
- Focus on positive, proactive interventions
- Suggest evidence-based approaches (visual supports, reinforcement systems, environmental modifications)
- Be specific and immediately actionable
- Consider antecedent management and teaching replacement behaviors
- Keep suggestions realistic for busy classroom staff
- Number your suggestions 1, 2, 3

Format each suggestion as:
1. [Strategy name]: [2-3 sentence practical description]
2. [Strategy name]: [2-3 sentence practical description]
3. [Strategy name]: [2-3 sentence practical description]`,

      intervention: `You are a behavior analyst helping design intervention plans for students with challenging behaviors.

Your task: Suggest a structured intervention approach based on the described behavior pattern.

Guidelines:
- Start with function-based thinking
- Suggest both preventive strategies and teaching alternatives
- Include data collection recommendations
- Be practical for general education settings
- Focus on teaching replacement behaviors
- Keep suggestions actionable and specific

Provide:
1. Hypothesized Function: [1-2 sentences]
2. Prevention Strategies: [2-3 specific strategies]
3. Replacement Behaviors: [What to teach instead]
4. Response Strategies: [How to respond when behavior occurs]
5. Data to Collect: [What to track]`
    };

    return prompts[focus] || prompts.strategies;
  }
};

// ========== WEEK CALCULATION UTILITIES ==========
const WeekUtils = {
  getMonday(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(d.setDate(diff));
  },

  getFriday(date) {
    const monday = this.getMonday(date);
    return new Date(monday.getTime() + 4 * 24 * 60 * 60 * 1000);
  },

  getCurrentWeek() {
    const now = new Date();
    const monday = this.getMonday(now);
    const friday = this.getFriday(now);
    return { start: monday, end: friday };
  },

  getLastWeek() {
    const now = new Date();
    const lastWeekDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    const monday = this.getMonday(lastWeekDate);
    const friday = this.getFriday(lastWeekDate);
    return { start: monday, end: friday };
  },

  formatDateRange(start, end) {
    const options = { month: 'short', day: 'numeric' };
    const startStr = start.toLocaleDateString('en-US', options);
    const endStr = end.toLocaleDateString('en-US', options);
    return `${startStr} - ${endStr}`;
  },

  isInWeek(dateStr, weekStart, weekEnd) {
    const date = new Date(dateStr);
    return date >= weekStart && date <= weekEnd;
  }
};

// ========== AUTHENTICATION LOGIC ==========
const AuthManager = {
  isSignUp: false,
  currentUser: null,

  init() {
    auth.onAuthStateChanged(user => {
      if (user) {
        this.currentUser = user;
        this.showMainApp();
        App.init();
      } else {
        this.currentUser = null;
        this.showLoginScreen();
      }
    });

    document.getElementById('authToggle').addEventListener('click', () => this.toggleAuthMode());
    document.getElementById('authButton').addEventListener('click', () => this.handleAuth());
    document.getElementById('logoutBtn').addEventListener('click', () => this.logout());

    document.getElementById('authPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.handleAuth();
    });
  },

  toggleAuthMode() {
    this.isSignUp = !this.isSignUp;
    document.getElementById('authTitle').textContent = this.isSignUp ? 'Sign Up' : 'Sign In';
    document.getElementById('authButton').textContent = this.isSignUp ? 'CREATE ACCOUNT' : 'SIGN IN';
    document.getElementById('authToggleText').innerHTML = this.isSignUp
      ? 'Already have an account? <a id="authToggle">Sign in</a>'
      : 'Don\'t have an account? <a id="authToggle">Sign up</a>';
   
    document.getElementById('authToggle').addEventListener('click', () => this.toggleAuthMode());
  },

  async handleAuth() {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    const errorDiv = document.getElementById('authError');

    if (!email || !password) {
      this.showError('Please enter both email and password');
      return;
    }

    try {
      if (this.isSignUp) {
        await auth.createUserWithEmailAndPassword(email, password);
      } else {
        await auth.signInWithEmailAndPassword(email, password);
      }
      errorDiv.style.display = 'none';
    } catch (error) {
      this.showError(this.getErrorMessage(error.code));
    }
  },

  showError(message) {
    const errorDiv = document.getElementById('authError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
  },

  getErrorMessage(code) {
    switch(code) {
      case 'auth/invalid-email': return 'Invalid email format';
      case 'auth/user-not-found': return 'No account found with this email';
      case 'auth/wrong-password': return 'Incorrect password';
      case 'auth/email-already-in-use': return 'Email already registered';
      case 'auth/weak-password': return 'Password must be at least 6 characters';
      default: return 'Authentication error. Please try again.';
    }
  },

  logout() {
    auth.signOut();
  },

  showLoginScreen() {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
  },

  showMainApp() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userEmail').textContent = this.currentUser.email;
  }
};

// ========== MAIN APP LOGIC ==========
const App = {
  logs: [],
  unsubscribe: null,

  init() {
    this.setupEventListeners();
    this.listenToLogs();
    this.updateWeeklyReportCards();
    console.log("StudentScope ready with Claude AI");
  },

  setupEventListeners() {
    document.getElementById('saveBtn').addEventListener('click', () => this.saveBehavior());
    document.getElementById('goodBehaviorBtn').addEventListener('click', () => this.saveGoodBehavior());
    document.getElementById('aiButton').addEventListener('click', () => this.generateAISuggestions());
  },

  updateWeeklyReportCards() {
    const currentWeek = WeekUtils.getCurrentWeek();
    const lastWeek = WeekUtils.getLastWeek();

    document.getElementById('thisWeekRange').textContent = WeekUtils.formatDateRange(currentWeek.start, currentWeek.end);
    document.getElementById('lastWeekRange').textContent = WeekUtils.formatDateRange(lastWeek.start, lastWeek.end);

    this.updateWeeklyCounts();
  },

  updateWeeklyCounts() {
    const currentWeek = WeekUtils.getCurrentWeek();
    const lastWeek = WeekUtils.getLastWeek();

    const currentWeekLogs = this.logs.filter(log => 
      WeekUtils.isInWeek(log.date, currentWeek.start, currentWeek.end)
    );

    const lastWeekLogs = this.logs.filter(log => 
      WeekUtils.isInWeek(log.date, lastWeek.start, lastWeek.end)
    );

    document.getElementById('thisWeekCount').textContent = 
      `${currentWeekLogs.length} behavior${currentWeekLogs.length !== 1 ? 's' : ''} logged`;
    
    document.getElementById('lastWeekCount').textContent = 
      `${lastWeekLogs.length} behavior${lastWeekLogs.length !== 1 ? 's' : ''} logged`;
  },

  listenToLogs() {
    const userId = auth.currentUser.uid;
   
    this.unsubscribe = db.collection('users')
      .doc(userId)
      .collection('logs')
      .orderBy('date', 'desc')
      .onSnapshot(snapshot => {
        this.logs = [];
        document.getElementById('logContainer').innerHTML = '';

        if (snapshot.empty) {
          document.getElementById('logContainer').innerHTML = `
            <div style="text-align:center;padding:40px 20px;color:#95a5a6;">
              <div style="font-size:3rem;opacity:0.5;">üìã</div>
              <p>No behaviors logged yet.</p>
              <p style="font-size:0.9rem;">Save your first behavior in the left column.</p>
            </div>
          `;
          this.updateWeeklyCounts();
          return;
        }

        snapshot.forEach(doc => {
          const log = { id: doc.id, ...doc.data() };
          this.logs.push(log);
          this.displayLog(log);
        });

        this.updateWeeklyCounts();
      });
  },

  async saveBehavior() {
    const studentName = document.getElementById('studentName').value.trim();
    const behavior = document.getElementById('behavior').value.trim();

    if (!studentName || !behavior) {
      alert("Please enter both student name and behavior description");
      return;
    }

    const log = {
      studentName: studentName,
      date: new Date().toISOString(),
      behavior: behavior,
      antecedent: "",
      consequence: "",
      comments: []
    };

    try {
      const userId = auth.currentUser.uid;
      await db.collection('users').doc(userId).collection('logs').add(log);
     
      document.getElementById('studentName').value = '';
      document.getElementById('behavior').value = '';
      document.getElementById('studentName').focus();
    } catch (error) {
      console.error('Error saving behavior:', error);
      alert('Failed to save behavior. Please try again.');
    }
  },

  async saveGoodBehavior() {
    const studentName = document.getElementById('studentName').value.trim();
    const behavior = document.getElementById('behavior').value.trim();

    if (!studentName || !behavior) {
      alert("Please enter both student name and behavior description");
      return;
    }

    const log = {
      studentName: studentName,
      date: new Date().toISOString(),
      behavior: `‚≠ê GOOD BEHAVIOR ALERT ‚≠ê\n${behavior}`,
      antecedent: "",
      consequence: "",
      comments: []
    };

    try {
      const userId = auth.currentUser.uid;
      await db.collection('users').doc(userId).collection('logs').add(log);
     
      document.getElementById('studentName').value = '';
      document.getElementById('behavior').value = '';
      document.getElementById('studentName').focus();
    } catch (error) {
      console.error('Error saving good behavior:', error);
      alert('Failed to save behavior. Please try again.');
    }
  },

  displayLog(log) {
    const container = document.getElementById('logContainer');
    const emptyState = container.querySelector('.empty-state');
    if (emptyState) container.removeChild(emptyState);

    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.dataset.id = log.id;

    const date = new Date(log.date).toLocaleDateString('en-US', {
      month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
    });

    const hasABC = log.antecedent || log.consequence;
    const hasComments = log.comments?.length > 0;

    entry.innerHTML = `
      <div class="student-name">${log.studentName}</div>
      <div class="log-date">${date}</div>
      <div style="margin-top:15px;line-height:1.5;"><strong>Behavior:</strong> ${log.behavior}</div>
      ${log.antecedent ? `<div style="margin-top:8px;"><strong>Antecedent:</strong> ${log.antecedent}</div>` : ''}
      ${log.consequence ? `<div style="margin-top:8px;"><strong>Consequence:</strong> ${log.consequence}</div>` : ''}
      ${hasComments ? `<div style="margin-top:15px;"><strong>Comments:</strong> ${log.comments.length}</div>` : ''}

      <button class="edit-abc-btn" onclick="App.toggleABCEditor('${log.id}')">
        ${hasABC || hasComments ? '‚úèÔ∏è Edit' : '‚ûï Add ABC/Comment'}
      </button>

      <div class="abc-expandable" id="abcEditor-${log.id}">
        <div style="margin-bottom:15px;">
          <label style="color:#2c3e50;font-size:0.9rem;font-weight:600;">Antecedent (What happened BEFORE?)</label>
          <textarea id="antecedent-${log.id}" style="width:100%;min-height:60px;padding:10px;">${log.antecedent || ''}</textarea>
        </div>
        <div style="margin-bottom:15px;">
          <label style="color:#2c3e50;font-size:0.9rem;font-weight:600;">Consequence (What happened AFTER?)</label>
          <textarea id="consequence-${log.id}" style="width:100%;min-height:60px;padding:10px;">${log.consequence || ''}</textarea>
        </div>
        <div style="border-top:1px dashed #c8d6e5;padding-top:15px;">
          <label style="color:#2c3e50;font-size:0.9rem;font-weight:600;">Add a Comment</label>
          <textarea id="newComment-${log.id}" style="width:100%;min-height:60px;padding:10px;" placeholder="Optional notes..."></textarea>
          <button onclick="App.addComment('${log.id}')" class="save-abc-btn">üí¨ Add Comment</button>
        </div>
        <button onclick="App.saveABCData('${log.id}')" class="save-abc-btn">üíæ Save ABC Data</button>
      </div>

      <button onclick="App.deleteLog('${log.id}')" class="delete-btn">üóëÔ∏è Delete</button>
    `;

    container.prepend(entry);
  },

  toggleABCEditor(logId) {
    const editor = document.getElementById(`abcEditor-${logId}`);
    const button = event.target;

    if (editor.classList.contains('expanded')) {
      editor.classList.remove('expanded');
      button.textContent = button.textContent.includes('Edit') ? '‚úèÔ∏è Edit' : '‚ûï Add ABC/Comment';
    } else {
      document.querySelectorAll('.abc-expandable.expanded').forEach(el => el.classList.remove('expanded'));
      editor.classList.add('expanded');
      button.textContent = '‚ñ≤ Close';
    }
  },

  async saveABCData(logId) {
    const antecedent = document.getElementById(`antecedent-${logId}`).value.trim();
    const consequence = document.getElementById(`consequence-${logId}`).value.trim();

    try {
      const userId = auth.currentUser.uid;
      await db.collection('users')
        .doc(userId)
        .collection('logs')
        .doc(logId)
        .update({
          antecedent: antecedent,
          consequence: consequence
        });

      document.getElementById(`abcEditor-${logId}`).classList.remove('expanded');
    } catch (error) {
      console.error('Error updating ABC data:', error);
      alert('Failed to save ABC data');
    }
  },

  async addComment(logId) {
    const commentText = document.getElementById(`newComment-${logId}`).value.trim();
    if (!commentText) return alert("Please enter a comment");

    const log = this.logs.find(l => l.id === logId);
    if (!log) return;

    const newComment = {
      text: commentText,
      timestamp: new Date().toISOString(),
      author: "Staff"
    };

    const updatedComments = [...(log.comments || []), newComment];

    try {
      const userId = auth.currentUser.uid;
      await db.collection('users')
        .doc(userId)
        .collection('logs')
        .doc(logId)
        .update({ comments: updatedComments });

      document.getElementById(`newComment-${logId}`).value = '';
    } catch (error) {
      console.error('Error adding comment:', error);
      alert('Failed to add comment');
    }
  },

  async deleteLog(id) {
    if (!confirm('Delete this behavior log?')) return;

    try {
      const userId = auth.currentUser.uid;
      await db.collection('users')
        .doc(userId)
        .collection('logs')
        .doc(id)
        .delete();
    } catch (error) {
      console.error('Error deleting log:', error);
      alert('Failed to delete log');
    }
  },

  // ========== WEEKLY REPORT FUNCTIONS ==========
  getWeeklyLogs(weekType) {
    const week = weekType === 'current' ? WeekUtils.getCurrentWeek() : WeekUtils.getLastWeek();
    return this.logs.filter(log => WeekUtils.isInWeek(log.date, week.start, week.end));
  },

  buildWeeklyReportText(weekType) {
    const week = weekType === 'current' ? WeekUtils.getCurrentWeek() : WeekUtils.getLastWeek();
    const weeklyLogs = this.getWeeklyLogs(weekType);
    const weekLabel = weekType === 'current' ? 'THIS WEEK' : 'LAST WEEK';

    let report = `STUDENTSCOPE ${weekLabel}'S BEHAVIOR REPORT\n`;
    report += `${WeekUtils.formatDateRange(week.start, week.end)}\n`;
    report += `Generated: ${new Date().toLocaleString()}\n`;
    report += `Total Entries: ${weeklyLogs.length}\n`;
    report += `\n${'='.repeat(60)}\n\n`;

    if (weeklyLogs.length === 0) {
      report += 'No behaviors logged for this week.\n';
    } else {
      weeklyLogs.forEach((log, index) => {
        const logDate = new Date(log.date);
        const dateTime = logDate.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
       
        report += `${index + 1}. ${log.studentName} - ${dateTime}\n`;
        report += `   Behavior: ${log.behavior}\n`;
       
        if (log.antecedent) {
          report += `   Antecedent: ${log.antecedent}\n`;
        }
        if (log.consequence) {
          report += `   Consequence: ${log.consequence}\n`;
        }
       
        if (log.comments && log.comments.length > 0) {
          report += `   Comments: ${log.comments.length} note(s)\n`;
        }
       
        report += `\n`;
      });
    }

    report += `${'='.repeat(60)}\n`;
    report += `\nGenerated by StudentScope - Behavior Tracking System`;

    return report;
  },

  emailWeeklyReport(weekType) {
    const weeklyLogs = this.getWeeklyLogs(weekType);
    
    if (weeklyLogs.length === 0) {
      alert(`No behaviors logged for ${weekType === 'current' ? 'this' : 'last'} week.`);
      return;
    }

    const week = weekType === 'current' ? WeekUtils.getCurrentWeek() : WeekUtils.getLastWeek();
    const subject = `StudentScope ${weekType === 'current' ? 'This' : 'Last'} Week's Report - ${WeekUtils.formatDateRange(week.start, week.end)}`;
    const body = this.buildWeeklyReportText(weekType);

    const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailtoLink;
  },

  printWeeklyReport(weekType) {
    const weeklyLogs = this.getWeeklyLogs(weekType);
    
    if (weeklyLogs.length === 0) {
      alert(`No behaviors logged for ${weekType === 'current' ? 'this' : 'last'} week.`);
      return;
    }

    const week = weekType === 'current' ? WeekUtils.getCurrentWeek() : WeekUtils.getLastWeek();
    const weekLabel = weekType === 'current' ? 'THIS WEEK' : 'LAST WEEK';

    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write(`
      <html>
        <head>
          <title>StudentScope ${weekLabel}'s Report</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; line-height: 1.6; }
            h1 { color: #2c3e50; margin-bottom: 10px; }
            .meta { color: #7f8c8d; margin-bottom: 30px; }
            .entry { margin-bottom: 30px; border-bottom: 2px solid #ecf0f1; padding-bottom: 20px; }
            .entry:last-child { border-bottom: none; }
            .student-name { font-size: 1.3rem; font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
            .date { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 10px; }
            .label { font-weight: 600; color: #34495e; }
            .footer { margin-top: 40px; text-align: center; color: #95a5a6; font-size: 0.9rem; }
          </style>
        </head>
        <body>
          <h1>STUDENTSCOPE ${weekLabel}'S BEHAVIOR REPORT</h1>
          <div class="meta">
            <strong>${WeekUtils.formatDateRange(week.start, week.end)}</strong><br>
            Generated: ${new Date().toLocaleString()}<br>
            Total Entries: ${weeklyLogs.length}
          </div>
          ${weeklyLogs.map(log => {
            const logDate = new Date(log.date).toLocaleString('en-US', {
              month: 'short',
              day: 'numeric',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            return `
              <div class="entry">
                <div class="student-name">${log.studentName}</div>
                <div class="date">${logDate}</div>
                <p><span class="label">Behavior:</span> ${log.behavior}</p>
                ${log.antecedent ? `<p><span class="label">Antecedent:</span> ${log.antecedent}</p>` : ''}
                ${log.consequence ? `<p><span class="label">Consequence:</span> ${log.consequence}</p>` : ''}
                ${log.comments && log.comments.length > 0 ? `<p><span class="label">Comments:</span> ${log.comments.length} note(s)</p>` : ''}
              </div>
            `;
          }).join('')}
          <div class="footer">Generated by StudentScope - Behavior Tracking System</div>
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
  },

  // ========== REAL CLAUDE AI ASSISTANT ==========
  async generateAISuggestions() {
    const prompt = document.getElementById('aiPrompt').value.trim();
    const focus = document.getElementById('aiFocus').value;
    const output = document.getElementById('aiOutput');

    if (!prompt) {
      alert("Please describe a situation");
      return;
    }

    // Show loading state
    output.innerHTML = `
      <div style="text-align:center;padding:30px;color:#7f8c8d;">
        <div style="font-size:2.5rem;margin-bottom:15px;">ü§î</div>
        <p style="font-size:1.1rem;font-weight:600;">Claude is analyzing...</p>
        <p style="font-size:0.9rem;margin-top:8px;">Generating professional suggestions</p>
      </div>
    `;

    try {
      // Call Claude API
      const suggestion = await ClaudeAI.generateSuggestion(prompt, focus);

      // Display result based on focus type
      if (focus === 'report') {
        // Professional rewrite - show before/after
        output.innerHTML = `
          <div style="background:white;padding:20px;border-radius:10px;margin-bottom:15px;border-left:4px solid #e67e22;">
            <h4 style="color:#7f8c8d;margin-bottom:8px;font-size:0.9rem;text-transform:uppercase;">Original Notes</h4>
            <p style="color:#2c3e50;font-style:italic;line-height:1.6;">"${prompt}"</p>
          </div>
          <div style="background:white;padding:20px;border-radius:10px;border-left:4px solid #27ae60;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <h4 style="color:#27ae60;margin:0;font-size:0.9rem;text-transform:uppercase;">‚ú® Professional Version</h4>
              <button onclick="App.copyToClipboard(this.parentElement.nextElementSibling.textContent)" 
                      style="padding:6px 12px;background:#27ae60;color:white;border:none;border-radius:6px;font-size:0.85rem;cursor:pointer;">
                üìã Copy
              </button>
            </div>
            <p style="color:#2c3e50;line-height:1.7;font-size:1.05rem;">${suggestion}</p>
          </div>
          <p style="text-align:center;margin-top:15px;color:#95a5a6;font-size:0.85rem;">
            ‚úì Ready for IEP meetings, progress reports, and official documentation
          </p>
        `;
      } else if (focus === 'parent') {
        // Parent email - show full draft
        output.innerHTML = `
          <div style="background:white;padding:20px;border-radius:10px;border-left:4px solid #9b59b6;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
              <h4 style="color:#9b59b6;margin:0;">üìß Parent Email Draft</h4>
              <button onclick="App.copyToClipboard(this.parentElement.nextElementSibling.textContent)" 
                      style="padding:6px 12px;background:#9b59b6;color:white;border:none;border-radius:6px;font-size:0.85rem;cursor:pointer;">
                üìã Copy Email
              </button>
            </div>
            <div style="background:#f8f5ff;padding:15px;border-radius:8px;font-family:monospace;font-size:0.9rem;white-space:pre-wrap;line-height:1.6;">${suggestion}</div>
          </div>
          <p style="text-align:center;margin-top:15px;color:#95a5a6;font-size:0.85rem;">
            ‚úì Review and personalize before sending
          </p>
        `;
      } else {
        // Strategies/Interventions - show as list
        output.innerHTML = `
          <div style="background:white;padding:20px;border-radius:10px;border-left:4px solid #3498db;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
              <h4 style="color:#3498db;margin:0;">üí° ${focus === 'strategies' ? 'Behavior Strategies' : 'Intervention Plan'}</h4>
              <button onclick="App.copyToClipboard(this.parentElement.nextElementSibling.textContent)" 
                      style="padding:6px 12px;background:#3498db;color:white;border:none;border-radius:6px;font-size:0.85rem;cursor:pointer;">
                üìã Copy
              </button>
            </div>
            <div style="color:#2c3e50;line-height:1.8;white-space:pre-wrap;">${suggestion}</div>
          </div>
        `;
      }

    } catch (error) {
      console.error('AI Generation Error:', error);
      output.innerHTML = `
        <div style="text-align:center;padding:30px;color:#e74c3c;">
          <div style="font-size:2.5rem;margin-bottom:15px;">‚ö†Ô∏è</div>
          <p style="font-size:1.1rem;font-weight:600;margin-bottom:10px;">Error Connecting to Claude AI</p>
          <p style="font-size:0.9rem;color:#7f8c8d;">Please check your API key configuration.</p>
          <p style="font-size:0.85rem;color:#95a5a6;margin-top:15px;">Error: ${error.message}</p>
        </div>
      `;
    }
  },

  // ========== COPY TO CLIPBOARD HELPER ==========
  copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text)
        .then(() => {
          const tempMsg = document.createElement('div');
          tempMsg.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            font-weight: 600;
          `;
          tempMsg.textContent = '‚úì Copied to clipboard!';
          document.body.appendChild(tempMsg);
          
          setTimeout(() => {
            document.body.removeChild(tempMsg);
          }, 2000);
        })
        .catch(err => {
          alert('Failed to copy. Please select and copy manually.');
        });
    } else {
      alert('Clipboard not supported. Please select and copy manually.');
    }
  }
};

// ========== START THE APP ==========
document.addEventListener('DOMContentLoaded', () => {
  AuthManager.init();
});
</script>
</body>
</html>
