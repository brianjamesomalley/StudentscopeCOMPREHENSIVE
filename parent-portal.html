<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StudentScope Parent Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #4F46E5;
  --primary-dark: #4338CA;
  --secondary: #10B981;
  --accent: #F59E0B;
  --danger: #EF4444;
  --success: #10B981;
  --gray-50: #F9FAFB;
  --gray-100: #F3F4F6;
  --gray-200: #E5E7EB;
  --gray-300: #D1D5DB;
  --gray-600: #4B5563;
  --gray-800: #1F2937;
  --gray-900: #111827;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  color: var(--gray-900);
}

/* LOGIN/SIGNUP SCREEN */
.auth-container {
  max-width: 450px;
  margin: 10vh auto;
  background: white;
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

.auth-header {
  text-align: center;
  margin-bottom: 30px;
}

.auth-header h1 {
  font-size: 32px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 10px;
}

.auth-input {
  width: 100%;
  padding: 14px;
  margin-bottom: 15px;
  border: 2px solid var(--gray-200);
  border-radius: 10px;
  font-size: 16px;
  font-family: inherit;
}

.auth-button {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  margin-top: 10px;
}

.auth-button:hover { opacity: 0.9; }

.auth-toggle {
  text-align: center;
  margin-top: 20px;
  color: var(--gray-600);
}

.auth-toggle a {
  color: var(--primary);
  cursor: pointer;
  text-decoration: underline;
}

.error-message {
  background: #FEE2E2;
  color: var(--danger);
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 15px;
  font-size: 14px;
}

/* ONBOARDING (Student Code Entry) */
.onboarding-container {
  max-width: 500px;
  margin: 10vh auto;
  background: white;
  padding: 50px;
  border-radius: 20px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  text-align: center;
}

.onboarding-container h2 {
  font-size: 28px;
  margin-bottom: 20px;
  color: var(--gray-900);
}

.code-input {
  width: 100%;
  padding: 20px;
  font-size: 28px;
  text-align: center;
  letter-spacing: 8px;
  font-weight: 700;
  border: 3px solid var(--primary);
  border-radius: 12px;
  margin: 30px 0;
  text-transform: uppercase;
  font-family: monospace;
}

/* MAIN PORTAL */
.portal-container {
  max-width: 1000px;
  margin: 0 auto;
  background: white;
  border-radius: 24px;
  overflow: hidden;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  min-height: 90vh;
  margin-top: 5vh;
  margin-bottom: 5vh;
}

.portal-header {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  padding: 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.student-info h1 {
  font-size: 28px;
  margin-bottom: 5px;
}

.logout-btn {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
  padding: 10px 20px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
}

.portal-content {
  padding: 30px;
}

/* NOTIFICATIONS */
.notification-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-bottom: 30px;
}

.notification-card {
  background: var(--gray-50);
  padding: 20px;
  border-radius: 12px;
  border-left: 4px solid var(--primary);
  cursor: pointer;
  transition: all 0.2s;
}

.notification-card:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.notification-card.unread {
  background: #E3F2FD;
  border-left-color: var(--primary);
}

.notification-card.negative {
  border-left-color: var(--danger);
}

.notification-card.positive {
  border-left-color: var(--success);
}

.notification-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.notification-badge {
  background: var(--primary);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
}

/* BEHAVIOR DETAIL */
.behavior-detail {
  background: white;
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  padding: 25px;
  margin-top: 20px;
}

.behavior-detail h3 {
  font-size: 20px;
  margin-bottom: 15px;
  color: var(--gray-900);
}

.behavior-text {
  background: var(--gray-50);
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
  line-height: 1.6;
}

.message-teacher-btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  border: none;
  padding: 14px 28px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  margin-top: 15px;
}

.message-teacher-btn:disabled {
  background: var(--gray-300);
  cursor: not-allowed;
}

/* CHAT INTERFACE */
.chat-container {
  background: var(--gray-50);
  border-radius: 12px;
  padding: 20px;
  margin-top: 20px;
  min-height: 300px;
  display: flex;
  flex-direction: column;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  margin-bottom: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.chat-bubble {
  max-width: 75%;
  padding: 14px 18px;
  border-radius: 16px;
  line-height: 1.5;
}

.chat-bubble.parent {
  background: var(--primary);
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.chat-bubble.teacher {
  background: white;
  border: 2px solid var(--gray-200);
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}

.chat-time {
  font-size: 11px;
  opacity: 0.7;
  margin-top: 6px;
}

.chat-input-area {
  display: flex;
  gap: 10px;
}

.chat-input {
  flex: 1;
  padding: 14px;
  border: 2px solid var(--gray-200);
  border-radius: 10px;
  font-size: 15px;
  font-family: inherit;
}

.chat-send-btn {
  background: var(--primary);
  color: white;
  border: none;
  padding: 14px 24px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
}

.chat-send-btn:disabled {
  background: var(--gray-300);
  cursor: not-allowed;
}

.chat-locked-message {
  background: #FFF3CD;
  color: #856404;
  padding: 15px;
  border-radius: 10px;
  text-align: center;
  margin-top: 15px;
  font-weight: 600;
}

/* UTILITIES */
.hidden { display: none; }

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--gray-600);
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 15px;
  opacity: 0.3;
}

@media (max-width: 768px) {
  .portal-header {
    flex-direction: column;
    gap: 15px;
  }
  
  .chat-bubble {
    max-width: 85%;
  }
}
</style>
</head>
<body>

<!-- ========== AUTH SCREEN ========== -->
<div id="authScreen" class="auth-container">
  <div class="auth-header">
    <h1>üë®‚Äçüë©‚Äçüëß StudentScope</h1>
    <p style="color: var(--gray-600);">Parent Portal</p>
  </div>
  
  <div id="authError" class="error-message hidden"></div>
  
  <h2 id="authTitle" style="margin-bottom: 25px; font-size: 24px;">Sign In</h2>
  
  <input type="email" id="authEmail" class="auth-input" placeholder="Email address" required>
  <input type="password" id="authPassword" class="auth-input" placeholder="Password" required>
  
  <button id="authButton" class="auth-button">SIGN IN</button>
  
  <div class="auth-toggle">
    <span id="authToggleText">Don't have an account? <a id="authToggle">Sign up</a></span>
  </div>
</div>

<!-- ========== ONBOARDING (Student Code Entry) ========== -->
<div id="onboardingScreen" class="onboarding-container hidden">
  <h2>Link Your Student</h2>
  <p style="color: var(--gray-600); margin-bottom: 20px;">
    Enter the 6-character access code provided by your child's teacher
  </p>
  
  <input type="text" id="studentCode" class="code-input" maxlength="6" placeholder="ABC123">
  
  <button id="linkStudentBtn" class="auth-button">LINK STUDENT</button>
  
  <div id="linkError" class="error-message hidden" style="margin-top: 15px;"></div>
</div>

<!-- ========== MAIN PORTAL ========== -->
<div id="portalScreen" class="portal-container hidden">
  <div class="portal-header">
    <div class="student-info">
      <h1 id="studentName">Loading...</h1>
      <p id="parentEmail" style="opacity: 0.9;"></p>
    </div>
    <button id="logoutBtn" class="logout-btn">Sign Out</button>
  </div>
  
  <div class="portal-content">
    <h2 style="margin-bottom: 20px;">üì¨ Notifications</h2>
    
    <div id="notificationsList" class="notification-list">
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <p>No notifications yet</p>
        <p style="font-size: 14px; margin-top: 10px;">You'll see behavior updates from your child's teacher here</p>
      </div>
    </div>
    
    <div id="behaviorDetailSection" class="behavior-detail hidden">
      <!-- Behavior details will load here -->
    </div>
    
    <div id="chatSection" class="hidden">
      <h3 style="margin-bottom: 15px;">üí¨ Message Teacher</h3>
      <div class="chat-container">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
          <input type="text" id="chatInput" class="chat-input" placeholder="Type your message...">
          <button id="chatSendBtn" class="chat-send-btn">Send</button>
        </div>
        <div id="chatLockedMessage" class="chat-locked-message hidden">
          ‚è≥ Waiting for teacher's response before you can send another message
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== FIREBASE SDK ========== -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// ========== FIREBASE CONFIG ==========
const firebaseConfig = {
  apiKey: "AIzaSyDFI44iKYUJNu9-67UkfHQHeKHBRAjKleA",
  authDomain: "studentscopebehaviorcenter.firebaseapp.com",
  projectId: "studentscopebehaviorcenter",
  storageBucket: "studentscopebehaviorcenter.firebasestorage.app",
  messagingSenderId: "311398911099",
  appId: "1:311398911099:web:6703268a2b65cdd969a6de"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ========== GLOBAL STATE ==========
let currentParentId = null;
let currentStudentId = null;
let currentStudent = null;
let currentConversationId = null;
let parentCanReply = true;

// ========== AUTH MANAGER ==========
const AuthManager = {
  isSignUp: false,

  init() {
    auth.onAuthStateChanged(async user => {
      if (user) {
        currentParentId = user.uid;
        
        // Check if parent has linked student
        const studentSnapshot = await db.collection('students')
          .where('parentId', '==', user.uid)
          .get();
        
        if (studentSnapshot.empty) {
          this.showOnboarding();
        } else {
          currentStudent = { id: studentSnapshot.docs[0].id, ...studentSnapshot.docs[0].data() };
          currentStudentId = currentStudent.id;
          this.showPortal();
          Portal.init();
        }
      } else {
        this.showAuth();
      }
    });

    document.getElementById('authToggle').addEventListener('click', () => this.toggleAuthMode());
    document.getElementById('authButton').addEventListener('click', () => this.handleAuth());
    document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
    document.getElementById('linkStudentBtn').addEventListener('click', () => this.linkStudent());
    
    document.getElementById('authPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.handleAuth();
    });
    document.getElementById('studentCode').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.linkStudent();
    });
  },

  toggleAuthMode() {
    this.isSignUp = !this.isSignUp;
    document.getElementById('authTitle').textContent = this.isSignUp ? 'Create Account' : 'Sign In';
    document.getElementById('authButton').textContent = this.isSignUp ? 'CREATE ACCOUNT' : 'SIGN IN';
    document.getElementById('authToggleText').innerHTML = this.isSignUp
      ? 'Already have an account? <a id="authToggle">Sign in</a>'
      : 'Don\'t have an account? <a id="authToggle">Sign up</a>';
    document.getElementById('authToggle').addEventListener('click', () => this.toggleAuthMode());
  },

  async handleAuth() {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;

    if (!email || !password) {
      this.showError('authError', 'Please enter both email and password');
      return;
    }

    try {
      if (this.isSignUp) {
        await auth.createUserWithEmailAndPassword(email, password);
      } else {
        await auth.signInWithEmailAndPassword(email, password);
      }
      document.getElementById('authError').classList.add('hidden');
    } catch (error) {
      this.showError('authError', this.getErrorMessage(error.code));
    }
  },

  async linkStudent() {
    const code = document.getElementById('studentCode').value.trim().toUpperCase();

    if (!code || code.length !== 6) {
      this.showError('linkError', 'Please enter a valid 6-character code');
      return;
    }

    try {
      // Find student with this access code
      const studentSnapshot = await db.collection('students')
        .where('accessCode', '==', code)
        .get();

      if (studentSnapshot.empty) {
        this.showError('linkError', 'Invalid access code. Please check with your teacher.');
        return;
      }

      const studentDoc = studentSnapshot.docs[0];
      const student = studentDoc.data();

      if (student.parentId) {
        this.showError('linkError', 'This student is already linked to another parent account.');
        return;
      }

      // Link parent to student
      await studentDoc.ref.update({
        parentId: currentParentId,
        parentEmail: auth.currentUser.email
      });

      // Create conversation
      await db.collection('conversations').add({
        studentId: studentDoc.id,
        studentName: student.name,
        teacherId: student.teacherId,
        parentId: currentParentId,
        parentEmail: auth.currentUser.email,
        messages: [],
        parentCanReply: true,
        createdAt: new Date().toISOString()
      });

      currentStudent = { id: studentDoc.id, ...student };
      currentStudentId = studentDoc.id;
      
      this.showPortal();
      Portal.init();
    } catch (error) {
      console.error('Error linking student:', error);
      this.showError('linkError', 'Failed to link student. Please try again.');
    }
  },

  showError(elementId, message) {
    const errorDiv = document.getElementById(elementId);
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
  },

  getErrorMessage(code) {
    switch(code) {
      case 'auth/invalid-email': return 'Invalid email format';
      case 'auth/user-not-found': return 'No account found with this email';
      case 'auth/wrong-password': return 'Incorrect password';
      case 'auth/email-already-in-use': return 'Email already registered';
      case 'auth/weak-password': return 'Password must be at least 6 characters';
      default: return 'Authentication error. Please try again.';
    }
  },

  showAuth() {
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('onboardingScreen').classList.add('hidden');
    document.getElementById('portalScreen').classList.add('hidden');
  },

  showOnboarding() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('onboardingScreen').classList.remove('hidden');
    document.getElementById('portalScreen').classList.add('hidden');
  },

  showPortal() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('onboardingScreen').classList.add('hidden');
    document.getElementById('portalScreen').classList.remove('hidden');
    
    document.getElementById('studentName').textContent = currentStudent.name;
    document.getElementById('parentEmail').textContent = auth.currentUser.email;
  }
};

// ========== PORTAL MANAGER ==========
const Portal = {
  init() {
    this.loadNotifications();
    this.loadConversation();
    
    document.getElementById('chatSendBtn').addEventListener('click', () => this.sendMessage());
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.sendMessage();
    });
  },

  async loadNotifications() {
    db.collection('notifications')
      .where('parentId', '==', currentParentId)
      .orderBy('timestamp', 'desc')
      .onSnapshot(snapshot => {
        const container = document.getElementById('notificationsList');
        container.innerHTML = '';

        if (snapshot.empty) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <p>No notifications yet</p>
              <p style="font-size: 14px; margin-top: 10px;">You'll see behavior updates from your child's teacher here</p>
            </div>
          `;
          return;
        }

        snapshot.forEach(doc => {
          const notification = { id: doc.id, ...doc.data() };
          const card = document.createElement('div');
          card.className = `notification-card ${notification.read ? '' : 'unread'} ${notification.behaviorType}`;
          card.onclick = () => this.viewNotification(notification);
          
          const date = new Date(notification.timestamp).toLocaleString();
          const icon = notification.behaviorType === 'positive' ? '‚≠ê' : 'üìù';
          
          card.innerHTML = `
            <div class="notification-header">
              <strong>${icon} ${notification.behaviorType === 'positive' ? 'Positive' : 'Behavior'} Update</strong>
              ${notification.read ? '' : '<span class="notification-badge">NEW</span>'}
            </div>
            <div style="color: var(--gray-600); font-size: 14px; margin-top: 5px;">
              ${notification.behaviorText.substring(0, 100)}${notification.behaviorText.length > 100 ? '...' : ''}
            </div>
            <div style="color: var(--gray-600); font-size: 12px; margin-top: 8px;">${date}</div>
          `;
          container.appendChild(card);
        });
      });
  },

  async viewNotification(notification) {
    // Mark as read
    await db.collection('notifications').doc(notification.id).update({ read: true });

    // Show behavior detail
    const detailSection = document.getElementById('behaviorDetailSection');
    detailSection.classList.remove('hidden');
    detailSection.innerHTML = `
      <h3>${notification.behaviorType === 'positive' ? '‚≠ê Positive Behavior' : 'üìù Behavior Report'}</h3>
      <div style="color: var(--gray-600); font-size: 14px; margin-bottom: 15px;">
        ${new Date(notification.timestamp).toLocaleString()}
      </div>
      <div class="behavior-text">${notification.behaviorText}</div>
      <button class="message-teacher-btn" onclick="Portal.openChat()">üí¨ Message Teacher</button>
    `;

    // Scroll to detail
    detailSection.scrollIntoView({ behavior: 'smooth' });
  },

  async loadConversation() {
    db.collection('conversations')
      .where('studentId', '==', currentStudentId)
      .where('parentId', '==', currentParentId)
      .onSnapshot(snapshot => {
        if (!snapshot.empty) {
          const conv = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
          currentConversationId = conv.id;
          parentCanReply = conv.parentCanReply !== false;
          this.updateChatUI(conv);
        }
      });
  },

  updateChatUI(conversation) {
    const messages = conversation.messages || [];
    const container = document.getElementById('chatMessages');
    container.innerHTML = '';

    if (messages.length === 0) {
      container.innerHTML = '<p style="text-align:center;color:var(--gray-600);">No messages yet. Click "Message Teacher" to start.</p>';
    } else {
      messages.forEach(msg => {
        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${msg.senderId === currentParentId ? 'parent' : 'teacher'}`;
        bubble.innerHTML = `
          <div>${msg.text}</div>
          <div class="chat-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
        `;
        container.appendChild(bubble);
      });
      container.scrollTop = container.scrollHeight;
    }

    // Update input state
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('chatSendBtn');
    const lockedMsg = document.getElementById('chatLockedMessage');

    if (parentCanReply) {
      chatInput.disabled = false;
      sendBtn.disabled = false;
      lockedMsg.classList.add('hidden');
    } else {
      chatInput.disabled = true;
      sendBtn.disabled = true;
      lockedMsg.classList.remove('hidden');
    }
  },

  openChat() {
    document.getElementById('chatSection').classList.remove('hidden');
    document.getElementById('chatSection').scrollIntoView({ behavior: 'smooth' });
  },

  async sendMessage() {
    if (!parentCanReply) return;

    const input = document.getElementById('chatInput');
    const text = input.value.trim();

    if (!text) return;

    const conv = (await db.collection('conversations').doc(currentConversationId).get()).data();
    const newMessage = {
      text: text,
      senderId: currentParentId,
      timestamp: new Date().toISOString(),
      read: false
    };

    const updatedMessages = [...(conv.messages || []), newMessage];

    try {
      await db.collection('conversations').doc(currentConversationId).update({
        messages: updatedMessages,
        parentCanReply: false  // Lock until teacher replies
      });

      input.value = '';
      parentCanReply = false;
    } catch (error) {
      console.error('Error sending message:', error);
      alert('Failed to send message');
    }
  }
};

// ========== START APP ==========
document.addEventListener('DOMContentLoaded', () => {
  AuthManager.init();
});
</script>
</body>
</html>
