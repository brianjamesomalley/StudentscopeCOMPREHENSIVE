
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StudentScope Teacher | Command Center</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
body { background: #f0f4f8; }

/* Dashboard Layout */
.dashboard { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }

/* Sidebar Navigation */
.sidebar { background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); color: white; padding: 30px 20px; }
.logo { font-size: 1.8rem; font-weight: 800; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
.logo span { background: #3b82f6; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; }
.nav-item { padding: 12px 16px; margin: 8px 0; border-radius: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; }
.nav-item:hover { background: rgba(255,255,255,0.1); }
.nav-item.active { background: #3b82f6; }
.user-section { margin-top: auto; padding-top: 40px; border-top: 1px solid rgba(255,255,255,0.1); }

/* Main Content */
.main-content { padding: 30px; overflow-y: auto; max-height: 100vh; }

/* Header */
.dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
.header-title h1 { font-size: 2rem; color: #0f172a; }
.header-title p { color: #64748b; }
.header-actions { display: flex; gap: 15px; align-items: center; }
.inbox-badge { background: #ef4444; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 700; }

/* Stats Cards */
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
.stat-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; }
.stat-title { color: #64748b; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
.stat-value { font-size: 2.5rem; font-weight: 800; color: #0f172a; }
.stat-change { display: flex; align-items: center; gap: 5px; margin-top: 8px; font-size: 0.9rem; color: #64748b; }

@media (max-width: 1200px) {
  .dashboard { grid-template-columns: 1fr; }
  .sidebar { position: fixed; left: -260px; transition: left 0.3s; z-index: 100; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
}

/* Action Cards Grid */
.action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
.action-card { background: white; padding: 25px; border-radius: 20px; border: 1px solid #e2e8f0; }
.action-card h3 { color: #0f172a; margin-bottom: 15px; font-size: 1.2rem; }

/* Form Elements */
.form-group { margin-bottom: 15px; }
label { display: block; margin-bottom: 8px; font-weight: 600; color: #0f172a; font-size: 0.9rem; }
input, textarea, select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; }
textarea { min-height: 100px; resize: vertical; }

/* Buttons */
.btn { padding: 12px 24px; border-radius: 30px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
.btn-primary { background: #3b82f6; color: white; }
.btn-primary:hover { background: #2563eb; transform: translateY(-2px); }
.btn-secondary { background: white; border: 1px solid #e2e8f0; color: #0f172a; }
.btn-secondary:hover { background: #f8fafc; }
.btn-success { background: #10b981; color: white; }
.btn-success:hover { background: #059669; }
.btn-full { width: 100%; justify-content: center; }

/* Student List */
.student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
.student-card { background: #f8fafc; padding: 15px; border-radius: 12px; border-left: 4px solid #3b82f6; cursor: pointer; transition: all 0.2s; }
.student-card:hover { background: #e0e6ed; transform: translateX(5px); }
.student-name { font-weight: 700; color: #0f172a; margin-bottom: 5px; }
.student-meta { font-size: 0.85rem; color: #64748b; }
.access-code { background: #e0e6ed; padding: 4px 8px; border-radius: 6px; font-family: monospace; font-weight: 700; display: inline-block; margin-top: 8px; }

/* Recent Behaviors */
.behavior-list { max-height: 400px; overflow-y: auto; }
.behavior-item { background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid; }
.behavior-item.positive { border-color: #10b981; }
.behavior-item.negative { border-color: #ef4444; }
.behavior-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
.behavior-student { font-weight: 700; color: #0f172a; }
.behavior-type { font-weight: 700; }
.behavior-text { color: #64748b; font-size: 0.9rem; margin-bottom: 5px; }
.behavior-time { font-size: 0.85rem; color: #94a3b8; }

/* Messages */
.message-list { max-height: 300px; overflow-y: auto; }
.message-item { background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; border-left: 4px solid #3b82f6; transition: all 0.2s; }
.message-item:hover { background: #e0e6ed; }
.message-item.unread { background: #dbeafe; }

/* Modal */
.modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
.modal.active { display: flex; }
.modal-content { background: white; padding: 40px; border-radius: 20px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; }
.modal-close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #94a3b8; }
.modal-close:hover { color: #0f172a; }

/* Student Report Modal */
.report-section { margin: 20px 0; padding: 20px; background: #f8fafc; border-radius: 12px; }
.report-section h3 { color: #0f172a; margin-bottom: 15px; }
.metric-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e2e8f0; }
.metric-label { color: #64748b; }
.metric-value { font-weight: 700; color: #0f172a; }

/* Chat Interface */
.chat-container { background: #f8fafc; border-radius: 12px; padding: 20px; height: 400px; display: flex; flex-direction: column; }
.chat-messages { flex: 1; overflow-y: auto; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
.chat-bubble { max-width: 70%; padding: 12px 16px; border-radius: 12px; }
.chat-bubble.teacher { background: #3b82f6; color: white; align-self: flex-end; }
.chat-bubble.parent { background: white; border: 2px solid #e2e8f0; align-self: flex-start; }
.chat-input-area { display: flex; gap: 10px; }
.chat-input { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; }

.hidden { display: none; }
.loading { text-align: center; padding: 40px; color: #64748b; }
</style>
</head>
<body>

<!-- Dashboard -->
<div class="dashboard">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      üéõÔ∏è StudentScope <span>TEACH</span>
    </div>
    
    <div class="nav-item active" onclick="showSection('overview')">
      <span>üìä</span> Overview
    </div>
    <div class="nav-item" onclick="showSection('students')">
      <span>üë•</span> Students
    </div>
    <div class="nav-item" onclick="showSection('log')">
      <span>üìù</span> Log Behavior
    </div>
    <div class="nav-item" onclick="showSection('messages')">
      <span>üì¨</span> Messages <span id="sidebarBadge" class="hidden inbox-badge">0</span>
    </div>
    
    <div class="user-section">
      <div class="nav-item" id="userEmail">
        <span>üë§</span> Loading...
      </div>
      <div class="nav-item" onclick="logout()">
        <span>üö™</span> Logout
      </div>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content">
    <!-- SECTION: OVERVIEW -->
    <div id="overviewSection">
      <div class="dashboard-header">
        <div class="header-title">
          <h1>Command Center</h1>
          <p>Real-time behavior tracking overview</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showSection('log')">
            <span>‚ö°</span> Quick Log
          </button>
        </div>
      </div>
      
      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-title">Today</div>
          <div class="stat-value" id="statToday">0</div>
          <div class="stat-change">Behaviors logged</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">This Week</div>
          <div class="stat-value" id="statWeek">0</div>
          <div class="stat-change">Last 7 days</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Positive</div>
          <div class="stat-value" id="statPositive" style="color:#10b981;">0</div>
          <div class="stat-change">‚úì Good behaviors</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Negative</div>
          <div class="stat-value" id="statNegative" style="color:#ef4444;">0</div>
          <div class="stat-change">‚ö† Incidents</div>
        </div>
      </div>
      
      <!-- Recent Behaviors -->
      <div class="action-card" style="margin-bottom:20px;">
        <h3>üìã Recent Activity</h3>
        <div class="behavior-list" id="recentBehaviorsList">
          <p class="loading">Loading behaviors...</p>
        </div>
      </div>
    </div>
    
    <!-- SECTION: STUDENTS -->
    <div id="studentsSection" class="hidden">
      <div class="dashboard-header">
        <div class="header-title">
          <h1>Student Management</h1>
          <p>Manage students and generate individual reports</p>
        </div>
      </div>
      
      <div class="action-grid">
        <!-- Add Student -->
        <div class="action-card">
          <h3>‚ûï Add New Student</h3>
          <div class="form-group">
            <label>Student Name</label>
            <input type="text" id="newStudentName" placeholder="Enter name">
          </div>
          <div class="form-group">
            <label>Grade</label>
            <input type="text" id="newStudentGrade" placeholder="Grade level">
          </div>
          <button class="btn btn-success btn-full" onclick="addStudent()">Add Student</button>
        </div>
        
        <!-- Student List (spans 2 columns) -->
        <div class="action-card" style="grid-column: span 2;">
          <h3>üë• Your Students</h3>
          <div class="student-grid" id="studentGrid">
            <p class="loading">Loading students...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- SECTION: LOG BEHAVIOR -->
    <div id="logSection" class="hidden">
      <div class="dashboard-header">
        <div class="header-title">
          <h1>Log Behavior</h1>
          <p>Quick behavior logging</p>
        </div>
      </div>
      
      <div class="action-card" style="max-width:600px;margin:0 auto;">
        <div class="form-group">
          <label>Student</label>
          <select id="logStudentSelect">
            <option value="">Select student...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Behavior Description</label>
          <textarea id="logBehaviorText" placeholder="Describe what happened..."></textarea>
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="logBehaviorType">
            <option value="negative">‚ö† Negative Behavior</option>
            <option value="positive">‚úì Positive Behavior</option>
          </select>
        </div>
        <button class="btn btn-primary btn-full" onclick="logBehavior()">
          <span>üíæ</span> Log Behavior
        </button>
      </div>
    </div>
    
    <!-- SECTION: MESSAGES -->
    <div id="messagesSection" class="hidden">
      <div class="dashboard-header">
        <div class="header-title">
          <h1>Parent Messages</h1>
          <p>Conversations with parents</p>
        </div>
      </div>
      
      <div class="action-card">
        <div class="message-list" id="messagesList">
          <p class="loading">Loading messages...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Student Report -->
<div id="studentReportModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeStudentReport()">&times;</span>
    <h2 id="reportStudentName" style="margin-bottom:20px;"></h2>
    
    <div class="report-section">
      <h3>üìä Behavior Summary</h3>
      <div class="metric-row">
        <span class="metric-label">Total Behaviors</span>
        <span class="metric-value" id="reportTotal">0</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Positive Behaviors</span>
        <span class="metric-value" style="color:#10b981;" id="reportPositive">0</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Negative Behaviors</span>
        <span class="metric-value" style="color:#ef4444;" id="reportNegative">0</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Arcade Points</span>
        <span class="metric-value" id="reportPoints">0</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Parent Linked</span>
        <span class="metric-value" id="reportParent">No</span>
      </div>
    </div>
    
    <div class="report-section">
      <h3>üìã Recent Behaviors (Last 7 Days)</h3>
      <div id="reportBehaviorsList"></div>
    </div>
    
    <div style="display:flex;gap:10px;margin-top:20px;">
      <button class="btn btn-primary" onclick="emailStudentReport()">
        <span>üìß</span> Email Report
      </button>
      <button class="btn btn-secondary" onclick="printStudentReport()">
        <span>üñ®Ô∏è</span> Print Report
      </button>
    </div>
  </div>
</div>

<!-- MODAL: Chat -->
<div id="chatModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeChat()">&times;</span>
    <h2 id="chatStudentName" style="margin-bottom:20px;"></h2>
    <div class="chat-container">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" class="chat-input" placeholder="Type your reply...">
        <button class="btn btn-primary" onclick="sendTeacherMessage()">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen" style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#f0f4f8;">
  <div style="background:white;padding:40px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.1);max-width:400px;width:90%;">
    <h1 style="text-align:center;color:#3b82f6;margin-bottom:10px;">üéõÔ∏è StudentScope</h1>
    <p style="text-align:center;color:#64748b;margin-bottom:30px;">Teacher Portal</p>
    <h2 id="authTitle" style="text-align:center;margin-bottom:20px;">Sign In</h2>
    <input type="email" id="authEmail" placeholder="Email" style="width:100%;padding:14px;margin-bottom:15px;border:2px solid #e2e8f0;border-radius:10px;">
    <input type="password" id="authPassword" placeholder="Password" style="width:100%;padding:14px;margin-bottom:15px;border:2px solid #e2e8f0;border-radius:10px;">
    <button id="authButton" class="btn btn-primary btn-full">SIGN IN</button>
    <div style="text-align:center;margin-top:20px;color:#64748b;">
      <span id="authToggleText">Don't have an account? <a id="authToggle" style="color:#3b82f6;cursor:pointer;text-decoration:underline;">Sign up</a></span>
    </div>
    <div id="authError" style="color:#ef4444;text-align:center;margin-top:15px;display:none;"></div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDFI44iKYUJNu9-67UkfHQHeKHBRAjKleA",
  authDomain: "studentscopebehaviorcenter.firebaseapp.com",
  projectId: "studentscopebehaviorcenter",
  storageBucket: "studentscopebehaviorcenter.firebasestorage.app",
  messagingSenderId: "311398911099",
  appId: "1:311398911099:web:6703268a2b65cdd969a6de"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Global State
let currentTeacherId = null;
let students = [];
let behaviors = [];
let conversations = [];
let currentConversationId = null;
let currentStudentForReport = null;

// Auth Manager
const AuthManager = {
  isSignUp: false,

  init() {
    auth.onAuthStateChanged(user => {
      if (user) {
        currentTeacherId = user.uid;
        document.getElementById('loginScreen').style.display = 'none';
        document.querySelector('.dashboard').style.display = 'grid';
        document.getElementById('userEmail').innerHTML = `<span>üë§</span> ${user.email}`;
        App.init();
      } else {
        document.getElementById('loginScreen').style.display = 'flex';
        document.querySelector('.dashboard').style.display = 'none';
      }
    });

    document.getElementById('authToggle').addEventListener('click', () => this.toggleAuthMode());
    document.getElementById('authButton').addEventListener('click', () => this.handleAuth());
    document.getElementById('authPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.handleAuth();
    });
  },

  toggleAuthMode() {
    this.isSignUp = !this.isSignUp;
    document.getElementById('authTitle').textContent = this.isSignUp ? 'Sign Up' : 'Sign In';
    document.getElementById('authButton').textContent = this.isSignUp ? 'CREATE ACCOUNT' : 'SIGN IN';
    document.getElementById('authToggleText').innerHTML = this.isSignUp
      ? 'Already have an account? <a id="authToggle">Sign in</a>'
      : 'Don\'t have an account? <a id="authToggle">Sign up</a>';
    document.getElementById('authToggle').addEventListener('click', () => this.toggleAuthMode());
  },

  async handleAuth() {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;

    if (!email || !password) {
      this.showError('Please enter both email and password');
      return;
    }

    try {
      if (this.isSignUp) {
        await auth.createUserWithEmailAndPassword(email, password);
      } else {
        await auth.signInWithEmailAndPassword(email, password);
      }
    } catch (error) {
      this.showError(error.message);
    }
  },

  showError(message) {
    const errorDiv = document.getElementById('authError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
  }
};

// Main App
const App = {
  init() {
    this.loadStudents();
    this.loadBehaviors();
    this.loadConversations();
  },

  async loadStudents() {
    const snapshot = await db.collection('students')
      .where('teacherId', '==', currentTeacherId)
      .get();

    students = [];
    snapshot.forEach(doc => {
      students.push({ id: doc.id, ...doc.data() });
    });

    this.updateStudentDropdowns();
    this.renderStudentGrid();
  },

  updateStudentDropdowns() {
    const select = document.getElementById('logStudentSelect');
    select.innerHTML = '<option value="">Select student...</option>';
    
    students.forEach(s => {
      const option = document.createElement('option');
      option.value = s.id;
      option.textContent = s.name;
      select.appendChild(option);
    });
  },

  renderStudentGrid() {
    const grid = document.getElementById('studentGrid');
    if (students.length === 0) {
      grid.innerHTML = '<p class="loading">No students yet. Add your first student!</p>';
      return;
    }

    grid.innerHTML = students.map(s => `
      <div class="student-card" onclick="openStudentReport('${s.id}')">
        <div class="student-name">${s.name}</div>
        <div class="student-meta">Grade ${s.grade}</div>
        ${s.parentId ? '<div class="student-meta" style="color:#10b981;">‚úì Parent Linked</div>' : ''}
        <div class="access-code">${s.accessCode}</div>
      </div>
    `).join('');
  },

  async loadBehaviors() {
    const snapshot = await db.collection('behaviors')
      .where('teacherId', '==', currentTeacherId)
      .orderBy('timestamp', 'desc')
      .limit(100)
      .get();

    behaviors = [];
    snapshot.forEach(doc => {
      behaviors.push({ id: doc.id, ...doc.data() });
    });

    this.updateStats();
    this.renderRecentBehaviors();
  },

  updateStats() {
    const now = new Date();
    const today = behaviors.filter(b => 
      new Date(b.timestamp).toDateString() === now.toDateString()
    ).length;
    
    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    const thisWeek = behaviors.filter(b => new Date(b.timestamp) > weekAgo).length;
    
    const positive = behaviors.filter(b => b.type === 'positive').length;
    const negative = behaviors.filter(b => b.type === 'negative').length;
    
    document.getElementById('statToday').textContent = today;
    document.getElementById('statWeek').textContent = thisWeek;
    document.getElementById('statPositive').textContent = positive;
    document.getElementById('statNegative').textContent = negative;
  },

  renderRecentBehaviors() {
    const list = document.getElementById('recentBehaviorsList');
    const recent = behaviors.slice(0, 10);

    if (recent.length === 0) {
      list.innerHTML = '<p class="loading">No behaviors logged yet</p>';
      return;
    }

    list.innerHTML = recent.map(b => `
      <div class="behavior-item ${b.type}">
        <div class="behavior-header">
          <span class="behavior-student">${b.studentName}</span>
          <span class="behavior-type" style="color:${b.type === 'positive' ? '#10b981' : '#ef4444'}">
            ${b.type === 'positive' ? '‚úì' : '‚ö†Ô∏è'}
          </span>
        </div>
        <div class="behavior-text">${b.behavior}</div>
        <div class="behavior-time">${new Date(b.timestamp).toLocaleString()}</div>
      </div>
    `).join('');
  },

  async loadConversations() {
    db.collection('conversations')
      .where('teacherId', '==', currentTeacherId)
      .onSnapshot(snapshot => {
        conversations = [];
        let unreadCount = 0;

        snapshot.forEach(doc => {
          const conv = { id: doc.id, ...doc.data() };
          conversations.push(conv);

          const lastMessage = conv.messages && conv.messages.length > 0 
            ? conv.messages[conv.messages.length - 1] 
            : null;
          if (lastMessage && lastMessage.senderId !== currentTeacherId && !lastMessage.read) {
            unreadCount++;
          }
        });

        if (unreadCount > 0) {
          document.getElementById('sidebarBadge').textContent = unreadCount;
          document.getElementById('sidebarBadge').classList.remove('hidden');
        } else {
          document.getElementById('sidebarBadge').classList.add('hidden');
        }

        this.renderMessages();
      });
  },

  renderMessages() {
    const list = document.getElementById('messagesList');
    
    if (conversations.length === 0) {
      list.innerHTML = '<p class="loading">No messages yet</p>';
      return;
    }

    list.innerHTML = conversations.map(conv => {
      const lastMessage = conv.messages && conv.messages.length > 0 
        ? conv.messages[conv.messages.length - 1] 
        : null;
      const isUnread = lastMessage && lastMessage.senderId !== currentTeacherId && !lastMessage.read;

      return `
        <div class="message-item ${isUnread ? 'unread' : ''}" onclick="openChat('${conv.id}')">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <strong>${conv.studentName}</strong>
            ${isUnread ? '<span style="color:#3b82f6;font-weight:bold;">NEW</span>' : ''}
          </div>
          <div style="color:#64748b;font-size:0.9rem;">
            ${lastMessage ? lastMessage.text.substring(0, 60) + '...' : 'No messages yet'}
          </div>
        </div>
      `;
    }).join('');
  }
};

// Actions
async function addStudent() {
  const name = document.getElementById('newStudentName').value.trim();
  const grade = document.getElementById('newStudentGrade').value.trim();

  if (!name || !grade) {
    alert('Please enter both name and grade');
    return;
  }

  const accessCode = Math.random().toString(36).substring(2, 8).toUpperCase();

  try {
    await db.collection('students').add({
      name: name,
      grade: grade,
      teacherId: currentTeacherId,
      accessCode: accessCode,
      parentId: null,
      points: 0,
      createdAt: new Date().toISOString()
    });

    document.getElementById('newStudentName').value = '';
    document.getElementById('newStudentGrade').value = '';
    App.loadStudents();
    alert(`Student added!\n\nAccess Code: ${accessCode}\n\nShare this code with parents.`);
  } catch (error) {
    alert('Failed to add student');
  }
}

async function logBehavior() {
  const studentId = document.getElementById('logStudentSelect').value;
  const behaviorText = document.getElementById('logBehaviorText').value.trim();
  const behaviorType = document.getElementById('logBehaviorType').value;

  if (!studentId || !behaviorText) {
    alert('Please select a student and describe the behavior');
    return;
  }

  const student = students.find(s => s.id === studentId);

  try {
    const logRef = await db.collection('behaviors').add({
      studentId: studentId,
      studentName: student.name,
      teacherId: currentTeacherId,
      behavior: behaviorText,
      type: behaviorType,
      timestamp: new Date().toISOString(),
      source: 'teacher-portal'
    });

    const pointChange = behaviorType === 'positive' ? 10 : -5;
    const newPoints = Math.max(0, (student.points || 0) + pointChange);
    await db.collection('students').doc(studentId).update({ points: newPoints });

    if (student.parentId) {
      await db.collection('notifications').add({
        parentId: student.parentId,
        studentId: studentId,
        studentName: student.name,
        logId: logRef.id,
        type: 'behavior_logged',
        behaviorType: behaviorType,
        behaviorText: behaviorText,
        timestamp: new Date().toISOString(),
        read: false
      });
    }

    document.getElementById('logBehaviorText').value = '';
    document.getElementById('logStudentSelect').selectedIndex = 0;

    App.loadBehaviors();
    showSection('overview');
    alert(`‚úì Behavior logged!${student.parentId ? '\n‚úì Parent notified' : ''}`);
  } catch (error) {
    alert('Failed to log behavior');
  }
}

async function openStudentReport(studentId) {
  currentStudentForReport = studentId;
  const student = students.find(s => s.id === studentId);
  const studentBehaviors = behaviors.filter(b => b.studentId === studentId);

  const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
  const recentBehaviors = studentBehaviors.filter(b => new Date(b.timestamp) > weekAgo);
  const positive = studentBehaviors.filter(b => b.type === 'positive').length;
  const negative = studentBehaviors.filter(b => b.type === 'negative').length;

  document.getElementById('reportStudentName').textContent = `üìä ${student.name} - Individual Report`;
  document.getElementById('reportTotal').textContent = studentBehaviors.length;
  document.getElementById('reportPositive').textContent = positive;
  document.getElementById('reportNegative').textContent = negative;
  document.getElementById('reportPoints').textContent = student.points || 0;
  document.getElementById('reportParent').textContent = student.parentId ? 'Yes ‚úì' : 'No';

  const behaviorsList = document.getElementById('reportBehaviorsList');
  if (recentBehaviors.length === 0) {
    behaviorsList.innerHTML = '<p style="color:#64748b;">No behaviors in the last 7 days</p>';
  } else {
    behaviorsList.innerHTML = recentBehaviors.map(b => `
      <div class="behavior-item ${b.type}" style="margin-bottom:15px;">
        <div class="behavior-header" style="margin-bottom:10px;">
          <span class="behavior-type" style="color:${b.type === 'positive' ? '#10b981' : '#ef4444'}">
            ${b.type === 'positive' ? '‚úì POSITIVE BEHAVIOR' : '‚ö† NEGATIVE BEHAVIOR'}
          </span>
          <span class="behavior-time">${new Date(b.timestamp).toLocaleString()}</span>
        </div>
        <div style="margin-bottom:8px;">
          <strong style="color:#0f172a;">Behavior:</strong>
          <div style="color:#475569;margin-top:4px;line-height:1.6;">${b.behavior}</div>
        </div>
        ${b.antecedent ? `
          <div style="margin-bottom:8px;">
            <strong style="color:#0f172a;">Antecedent:</strong>
            <div style="color:#475569;margin-top:4px;line-height:1.6;">${b.antecedent}</div>
          </div>
        ` : ''}
        ${b.consequence ? `
          <div style="margin-bottom:8px;">
            <strong style="color:#0f172a;">Consequence:</strong>
            <div style="color:#475569;margin-top:4px;line-height:1.6;">${b.consequence}</div>
          </div>
        ` : ''}
        ${b.comments && b.comments.length > 0 ? `
          <div style="margin-top:10px;padding-top:10px;border-top:1px solid #e2e8f0;">
            <strong style="color:#0f172a;">Staff Comments (${b.comments.length}):</strong>
            ${b.comments.map(c => `
              <div style="color:#475569;margin-top:6px;padding-left:12px;border-left:2px solid #cbd5e1;">
                ${c.text} <em style="color:#94a3b8;font-size:0.85rem;">(${new Date(c.timestamp).toLocaleString()})</em>
              </div>
            `).join('')}
          </div>
        ` : ''}
      </div>
    `).join('');
  }

  document.getElementById('studentReportModal').classList.add('active');
}

function closeStudentReport() {
  document.getElementById('studentReportModal').classList.remove('active');
  currentStudentForReport = null;
}

function emailStudentReport() {
  const student = students.find(s => s.id === currentStudentForReport);
  const studentBehaviors = behaviors.filter(b => b.studentId === currentStudentForReport);
  const positive = studentBehaviors.filter(b => b.type === 'positive').length;
  const negative = studentBehaviors.filter(b => b.type === 'negative').length;

  const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
  const recentBehaviors = studentBehaviors.filter(b => new Date(b.timestamp) > weekAgo);

  let emailBody = `STUDENTSCOPE INDIVIDUAL REPORT\n`;
  emailBody += `${'='.repeat(60)}\n\n`;
  emailBody += `Student: ${student.name}\n`;
  emailBody += `Grade: ${student.grade}\n`;
  emailBody += `Report Generated: ${new Date().toLocaleString()}\n`;
  emailBody += `Report Period: Last 7 Days\n\n`;
  emailBody += `BEHAVIOR SUMMARY\n`;
  emailBody += `${'-'.repeat(60)}\n`;
  emailBody += `Total Behaviors (All Time): ${studentBehaviors.length}\n`;
  emailBody += `Positive Behaviors: ${positive}\n`;
  emailBody += `Negative Behaviors: ${negative}\n`;
  emailBody += `Arcade Points: ${student.points || 0}\n`;
  emailBody += `Parent Portal Linked: ${student.parentId ? 'Yes' : 'No'}\n\n`;
  emailBody += `${'='.repeat(60)}\n\n`;
  emailBody += `DETAILED BEHAVIOR LOG (Last 7 Days)\n\n`;

  if (recentBehaviors.length === 0) {
    emailBody += `No behaviors logged in the last 7 days.\n`;
  } else {
    recentBehaviors.forEach((b, index) => {
      const date = new Date(b.timestamp).toLocaleString();
      emailBody += `${index + 1}. ${b.type === 'positive' ? '‚úì POSITIVE BEHAVIOR' : '‚ö† NEGATIVE BEHAVIOR'}\n`;
      emailBody += `   Date/Time: ${date}\n`;
      emailBody += `   Behavior: ${b.behavior}\n`;
      
      if (b.antecedent) {
        emailBody += `   Antecedent (What happened before): ${b.antecedent}\n`;
      }
      if (b.consequence) {
        emailBody += `   Consequence (What happened after): ${b.consequence}\n`;
      }
      if (b.comments && b.comments.length > 0) {
        emailBody += `   Staff Comments:\n`;
        b.comments.forEach(c => {
          emailBody += `     - ${c.text} (${new Date(c.timestamp).toLocaleString()})\n`;
        });
      }
      emailBody += `\n`;
    });
  }

  emailBody += `${'='.repeat(60)}\n`;
  emailBody += `\nGenerated by StudentScope Behavior Tracking System\n`;
  emailBody += `For IEP documentation and case management\n`;

  const subject = `StudentScope Individual Report: ${student.name} (${new Date().toLocaleDateString()})`;
  const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
  window.location.href = mailtoLink;
}

function printStudentReport() {
  window.print();
}

async function openChat(conversationId) {
  currentConversationId = conversationId;
  const conv = conversations.find(c => c.id === conversationId);

  document.getElementById('chatStudentName').textContent = `üí¨ ${conv.studentName}`;
  document.getElementById('chatModal').classList.add('active');

  loadChatMessages();

  if (conv.messages) {
    const updatedMessages = conv.messages.map(msg => {
      if (msg.senderId !== currentTeacherId) {
        return { ...msg, read: true };
      }
      return msg;
    });

    await db.collection('conversations').doc(conversationId).update({
      messages: updatedMessages
    });
  }
}

function loadChatMessages() {
  const conv = conversations.find(c => c.id === currentConversationId);
  const container = document.getElementById('chatMessages');
  container.innerHTML = '';

  if (!conv.messages || conv.messages.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:#64748b;">No messages yet</p>';
    return;
  }

  conv.messages.forEach(msg => {
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble ${msg.senderId === currentTeacherId ? 'teacher' : 'parent'}`;
    bubble.innerHTML = `
      <div>${msg.text}</div>
      <div style="font-size:0.8rem;margin-top:5px;opacity:0.7;">
        ${new Date(msg.timestamp).toLocaleTimeString()}
      </div>
    `;
    container.appendChild(bubble);
  });

  container.scrollTop = container.scrollHeight;
}

async function sendTeacherMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();

  if (!text) return;

  const conv = conversations.find(c => c.id === currentConversationId);
  const newMessage = {
    text: text,
    senderId: currentTeacherId,
    timestamp: new Date().toISOString(),
    read: false
  };

  const updatedMessages = [...(conv.messages || []), newMessage];

  try {
    await db.collection('conversations').doc(currentConversationId).update({
      messages: updatedMessages,
      parentCanReply: true
    });

    input.value = '';
    App.loadConversations();
    setTimeout(() => loadChatMessages(), 500);
  } catch (error) {
    alert('Failed to send message');
  }
}

function closeChat() {
  document.getElementById('chatModal').classList.remove('active');
  currentConversationId = null;
}

// Section Navigation
function showSection(section) {
  document.querySelectorAll('.main-content > div').forEach(div => div.classList.add('hidden'));
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

  if (section === 'overview') {
    document.getElementById('overviewSection').classList.remove('hidden');
    document.querySelectorAll('.nav-item')[0].classList.add('active');
  } else if (section === 'students') {
    document.getElementById('studentsSection').classList.remove('hidden');
    document.querySelectorAll('.nav-item')[1].classList.add('active');
  } else if (section === 'log') {
    document.getElementById('logSection').classList.remove('hidden');
    document.querySelectorAll('.nav-item')[2].classList.add('active');
  } else if (section === 'messages') {
    document.getElementById('messagesSection').classList.remove('hidden');
    document.querySelectorAll('.nav-item')[3].classList.add('active');
  }
}

function logout() {
  auth.signOut();
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  AuthManager.init();
});
</script>
</body>
</html>
